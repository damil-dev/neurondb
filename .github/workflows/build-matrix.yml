name: Build Matrix

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  build-extension:
    name: Build Extension (PG ${{ matrix.pg_version }}, ${{ matrix.compiler }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # PostgreSQL versions
          - pg_version: "16"
            os: ubuntu-20.04
            compiler: gcc-9
          - pg_version: "16"
            os: ubuntu-22.04
            compiler: gcc-11
          - pg_version: "17"
            os: ubuntu-22.04
            compiler: gcc-12
          - pg_version: "17"
            os: debian-11
            compiler: gcc-10
          - pg_version: "18"
            os: ubuntu-22.04
            compiler: clang-14
          - pg_version: "18"
            os: macos-13
            compiler: clang-15
          - pg_version: "18"
            os: macos-14
            compiler: clang-15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up compiler
        if: runner.os == 'Linux'
        run: |
          if [[ "${{ matrix.compiler }}" == gcc-* ]]; then
            sudo apt-get update
            VERSION=$(echo "${{ matrix.compiler }}" | cut -d- -f2)
            sudo apt-get install -y gcc-$VERSION g++-$VERSION
            sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-$VERSION 100
            sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-$VERSION 100
          elif [[ "${{ matrix.compiler }}" == clang-* ]]; then
            sudo apt-get update
            VERSION=$(echo "${{ matrix.compiler }}" | cut -d- -f2)
            sudo apt-get install -y clang-$VERSION
            sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-$VERSION 100
          fi
      
      - name: Install PostgreSQL development headers
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-server-dev-${{ matrix.pg_version }}
      
      - name: Install PostgreSQL (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install postgresql@${{ matrix.pg_version }}
          echo "$(brew --prefix postgresql@${{ matrix.pg_version }})/bin" >> $GITHUB_PATH
      
      - name: Install build dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get install -y build-essential make
      
      - name: Build NeuronDB extension
        working-directory: NeuronDB
        run: |
          if [ "${{ runner.os }}" == "Linux" ]; then
            PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config make clean
            PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config make
          else
            PG_CONFIG=$(brew --prefix postgresql@${{ matrix.pg_version }})/bin/pg_config make clean
            PG_CONFIG=$(brew --prefix postgresql@${{ matrix.pg_version }})/bin/pg_config make
          fi
        env:
          CC: ${{ matrix.compiler == 'gcc-9' && 'gcc' || matrix.compiler == 'gcc-11' && 'gcc' || matrix.compiler == 'gcc-12' && 'gcc' || matrix.compiler == 'gcc-10' && 'gcc' || 'clang' }}
          CXX: ${{ matrix.compiler == 'gcc-9' && 'g++' || matrix.compiler == 'gcc-11' && 'g++' || matrix.compiler == 'gcc-12' && 'g++' || matrix.compiler == 'gcc-10' && 'g++' || 'clang++' }}
      
      - name: Check build artifacts
        working-directory: NeuronDB
        run: |
          if [ -f neurondb.so ] || [ -f neurondb.dylib ]; then
            echo "Build successful: extension binary found"
            ls -lh neurondb.*
          else
            echo "Build failed: extension binary not found"
            exit 1
          fi
      
      - name: Run basic tests
        working-directory: NeuronDB
        run: |
          if [ "${{ runner.os }}" == "Linux" ]; then
            PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config make installcheck || true
          fi
        continue-on-error: true

  build-go-components:
    name: Build Go Components (Go ${{ matrix.go_version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        go_version: ["1.21", "1.22", "1.23"]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go_version }}
      
      - name: Build NeuronAgent
        working-directory: NeuronAgent
        run: |
          go build -v -o neuronagent ./cmd/agent-server
          ./neuronagent --version || echo "Version check not available"
      
      - name: Build NeuronMCP
        working-directory: NeuronMCP
        run: |
          go build -v -o neurondb-mcp ./cmd/neurondb-mcp
          ./neurondb-mcp --version || echo "Version check not available"
      
      - name: Run Go tests
        run: |
          cd NeuronAgent && go test ./... -v || true
          cd ../NeuronMCP && go test ./... -v || true
        continue-on-error: true
      
      - name: Check binaries
        run: |
          file NeuronAgent/neuronagent
          file NeuronMCP/neurondb-mcp
          ls -lh NeuronAgent/neuronagent NeuronMCP/neurondb-mcp

  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-extension, build-go-components]
    if: always()
    
    steps:
      - name: Check build status
        run: |
          echo "## Build Matrix Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All build jobs completed. Check individual job results for details." >> $GITHUB_STEP_SUMMARY

