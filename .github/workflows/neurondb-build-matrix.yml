name: NeuronDB - Build Matrix

on:
  workflow_dispatch:

jobs:
  build-test:
    name: Build and Test (PG ${{ matrix.pg_version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        pg_version: [16, 17, 18]

    services:
      postgres:
        image: postgres:${{ matrix.pg_version }}
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - name: Install PostgreSQL development packages
        run: |
          sudo apt-get update
          sudo apt-get install -y curl ca-certificates
          # Add PostgreSQL APT repository for PostgreSQL 17+
          sudo install -d /usr/share/postgresql-common/pgdg
          sudo curl -o /usr/share/postgresql-common/pgdg/apt.postgresql.org.asc --fail https://www.postgresql.org/media/keys/ACCC4CF8.asc
          sudo sh -c 'echo "deb [signed-by=/usr/share/postgresql-common/pgdg/apt.postgresql.org.asc] https://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          sudo apt-get update
          # Install both server-dev and server packages to ensure extension files go to correct location
          sudo apt-get install -y postgresql-server-dev-${{ matrix.pg_version }} postgresql-${{ matrix.pg_version }} build-essential make libssl-dev libcurl4-openssl-dev

      - name: Install ONNX Runtime
        run: |
          wget https://github.com/microsoft/onnxruntime/releases/download/v1.17.0/onnxruntime-linux-x64-1.17.0.tgz
          sudo tar -xzf onnxruntime-linux-x64-1.17.0.tgz -C /usr/local/
          sudo mv /usr/local/onnxruntime-linux-x64-1.17.0 /usr/local/onnxruntime

      - name: Build NeuronDB extension
        working-directory: NeuronDB
        run: |
          ./build.sh
        env:
          GPU_BACKENDS: none
          ONNX_RUNTIME_PATH: /usr/local/onnxruntime

      - name: Install extension
        working-directory: NeuronDB
        run: |
          # Find the correct pg_config for the PostgreSQL version in use
          PG_CONFIG_PATH=$(which pg_config || find /usr -name pg_config 2>/dev/null | head -1)
          if [ -z "$PG_CONFIG_PATH" ]; then
            PG_CONFIG_PATH=/usr/bin/pg_config
          fi
          echo "Using PG_CONFIG: $PG_CONFIG_PATH"
          $PG_CONFIG_PATH --version
          sudo make install PG_CONFIG=$PG_CONFIG_PATH
          # If control file specifies version 2.0 but we installed 1.0.sql, create 2.0.sql
          SHAREDIR=$($PG_CONFIG_PATH --sharedir)
          if [ -f "$SHAREDIR/extension/neurondb.control" ]; then
            DEFAULT_VERSION=$(grep -E "^default_version\s*=" "$SHAREDIR/extension/neurondb.control" | sed 's/.*=\s*\(.*\)/\1/' | tr -d "'\" " || echo "1.0")
            if [ "$DEFAULT_VERSION" = "2.0" ] && [ -f "$SHAREDIR/extension/neurondb--1.0.sql" ] && [ ! -f "$SHAREDIR/extension/neurondb--2.0.sql" ]; then
              echo "Control file specifies version 2.0, creating neurondb--2.0.sql from 1.0..."
              sudo cp "$SHAREDIR/extension/neurondb--1.0.sql" "$SHAREDIR/extension/neurondb--2.0.sql"
            fi
          fi
        env:
          PG_CONFIG: /usr/bin/pg_config

      - name: Copy extension to Docker container
        run: |
          # Get the PostgreSQL container ID
          CONTAINER_ID=$(docker ps --filter "ancestor=postgres:${{ matrix.pg_version }}" --format "{{.ID}}" | head -1)
          if [ -z "$CONTAINER_ID" ]; then
            echo "Warning: Could not find PostgreSQL container"
            exit 1
          fi
          echo "Found PostgreSQL container: $CONTAINER_ID"
          # Install required dependencies in the container
          docker exec $CONTAINER_ID bash -c "apt-get update && apt-get install -y libcurl4 libssl3 || apt-get install -y libcurl4-openssl-dev libssl-dev || true"
          # Copy extension files into the container
          docker cp /usr/share/postgresql/${{ matrix.pg_version }}/extension/neurondb.control $CONTAINER_ID:/usr/share/postgresql/${{ matrix.pg_version }}/extension/ 2>/dev/null || true
          docker cp /usr/share/postgresql/${{ matrix.pg_version }}/extension/neurondb--*.sql $CONTAINER_ID:/usr/share/postgresql/${{ matrix.pg_version }}/extension/ 2>/dev/null || true
          docker cp /usr/lib/postgresql/${{ matrix.pg_version }}/lib/neurondb.so $CONTAINER_ID:/usr/lib/postgresql/${{ matrix.pg_version }}/lib/ 2>/dev/null || true
          # If control file specifies version 2.0, ensure 2.0.sql exists in container
          SHAREDIR="/usr/share/postgresql/${{ matrix.pg_version }}/extension"
          if docker exec $CONTAINER_ID test -f "$SHAREDIR/neurondb.control"; then
            DEFAULT_VERSION=$(docker exec $CONTAINER_ID grep -E "^default_version\s*=" "$SHAREDIR/neurondb.control" 2>/dev/null | sed 's/.*=\s*\(.*\)/\1/' | tr -d "'\" " || echo "1.0")
            echo "Detected default_version: $DEFAULT_VERSION"
            if [ "$DEFAULT_VERSION" = "2.0" ]; then
              echo "Control file specifies version 2.0, ensuring neurondb--2.0.sql exists in container..."
              docker exec $CONTAINER_ID bash -c "if [ -f $SHAREDIR/neurondb--1.0.sql ] && [ ! -f $SHAREDIR/neurondb--2.0.sql ]; then cp $SHAREDIR/neurondb--1.0.sql $SHAREDIR/neurondb--2.0.sql && echo 'Created neurondb--2.0.sql'; else echo 'neurondb--2.0.sql already exists or 1.0.sql not found'; fi" || echo "Warning: Could not create 2.0.sql in container"
              # Verify it was created
              docker exec $CONTAINER_ID ls -la $SHAREDIR/neurondb--*.sql || echo "Warning: Could not list SQL files"
            fi
          fi
          # Copy ONNX Runtime if it exists
          if [ -d "/usr/local/onnxruntime" ]; then
            docker exec $CONTAINER_ID mkdir -p /usr/local/onnxruntime
            docker cp /usr/local/onnxruntime/. $CONTAINER_ID:/usr/local/onnxruntime/ 2>/dev/null || true
          fi
          # Configure shared_preload_libraries in PostgreSQL
          docker exec $CONTAINER_ID bash -c "echo \"shared_preload_libraries = 'neurondb'\" >> /var/lib/postgresql/data/postgresql.conf" || \
          docker exec $CONTAINER_ID bash -c "echo \"shared_preload_libraries = 'neurondb'\" >> \$(psql -U postgres -t -c 'SHOW config_file;' | tr -d ' ')" || \
          docker exec $CONTAINER_ID bash -c "find /var/lib/postgresql -name postgresql.conf -exec sh -c 'echo \"shared_preload_libraries = '\''neurondb'\''\" >> {}' \\;"
          # Restart PostgreSQL to load the configuration
          docker restart $CONTAINER_ID
          # Wait for PostgreSQL to be ready
          sleep 5
          for i in {1..30}; do
            if docker exec $CONTAINER_ID pg_isready -U postgres >/dev/null 2>&1; then
              echo "PostgreSQL is ready"
              break
            fi
            echo "Waiting for PostgreSQL... ($i/30)"
            sleep 2
          done
          # Verify files were copied
          docker exec $CONTAINER_ID ls -la /usr/share/postgresql/${{ matrix.pg_version }}/extension/neurondb* || echo "Warning: Extension files not found in container"
          docker exec $CONTAINER_ID ldd /usr/lib/postgresql/${{ matrix.pg_version }}/lib/neurondb.so || echo "Warning: Could not check library dependencies"

      - name: Create extension in test database
        run: |
          PGPASSWORD=postgres psql -h localhost -U postgres -d test -c "CREATE EXTENSION neurondb;"

      - name: Run extension tests
        run: |
          PGPASSWORD=postgres psql -h localhost -U postgres -d test -c "SELECT neurondb.version();"

      - name: Check extension loads
        run: |
          PGPASSWORD=postgres psql -h localhost -U postgres -d test -c "SELECT * FROM pg_extension WHERE extname = 'neurondb';"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: neurondb-pg${{ matrix.pg_version }}-build
          path: NeuronDB/neurondb.so
          retention-days: 7

