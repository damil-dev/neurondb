name: Integration Tests (Full Ecosystem)

on:
  push:
    branches: [main, develop]
    paths:
      - 'docker-compose.yml'
      - 'NeuronDB/**'
      - 'NeuronAgent/**'
      - 'NeuronMCP/**'
      - 'NeuronDesktop/**'
      - '.github/workflows/integration-tests-full-ecosystem.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'docker-compose.yml'
      - 'NeuronDB/**'
      - 'NeuronAgent/**'
      - 'NeuronMCP/**'
      - 'NeuronDesktop/**'
      - '.github/workflows/integration-tests-full-ecosystem.yml'
  workflow_dispatch:

jobs:
  integration-test:
    name: Docker Compose Integration Test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Start services
        run: |
          docker compose up -d
          # Wait for services to be healthy
          timeout 120 bash -c 'until docker compose ps | grep -q healthy; do sleep 5; done' || true
          sleep 30  # Additional wait time

      - name: Check service health
        run: |
          docker compose ps
          # Check NeuronDB
          docker compose exec -T neurondb psql -U neurondb -d neurondb -c "SELECT neurondb.version();" || exit 1
          # Check NeuronAgent
          curl -f http://localhost:8080/health || exit 1
          # Check NeuronDesktop API
          curl -f http://localhost:8081/health || exit 1

      - name: Run health check script
        run: |
          chmod +x scripts/health-check.sh
          ./scripts/health-check.sh || exit 1

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v
