name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      id-token: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          fi
      
      - name: Build NeuronDB image
        run: |
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t ghcr.io/neurondb/neurondb-postgres:${{ steps.version.outputs.version }} \
            -t ghcr.io/neurondb/neurondb-postgres:latest \
            --push \
            -f dockers/neurondb/Dockerfile \
            .
      
      - name: Build NeuronAgent image
        run: |
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t ghcr.io/neurondb/neuronagent:${{ steps.version.outputs.version }} \
            -t ghcr.io/neurondb/neuronagent:latest \
            --push \
            -f NeuronAgent/docker/Dockerfile \
            NeuronAgent/
      
      - name: Build NeuronMCP image
        run: |
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t ghcr.io/neurondb/neuronmcp:${{ steps.version.outputs.version }} \
            -t ghcr.io/neurondb/neuronmcp:latest \
            --push \
            -f NeuronMCP/docker/Dockerfile \
            NeuronMCP/
      
      - name: Build NeuronDesktop API image
        run: |
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t ghcr.io/neurondb/neurondesktop-api:${{ steps.version.outputs.version }} \
            -t ghcr.io/neurondb/neurondesktop-api:latest \
            --push \
            -f NeuronDesktop/api/Dockerfile \
            NeuronDesktop/api/
      
      - name: Build NeuronDesktop Frontend image
        continue-on-error: true
        run: |
          if [ -f dockers/neurondesktop/frontend/Dockerfile ]; then
            docker buildx build \
              --platform linux/amd64,linux/arm64 \
              -t ghcr.io/neurondb/neurondesktop-frontend:${{ steps.version.outputs.version }} \
              -t ghcr.io/neurondb/neurondesktop-frontend:latest \
              --push \
              -f dockers/neurondesktop/frontend/Dockerfile \
              NeuronDesktop/frontend/
          elif [ -f NeuronDesktop/frontend/Dockerfile ]; then
            docker buildx build \
              --platform linux/amd64,linux/arm64 \
              -t ghcr.io/neurondb/neurondesktop-frontend:${{ steps.version.outputs.version }} \
              -t ghcr.io/neurondb/neurondesktop-frontend:latest \
              --push \
              -f NeuronDesktop/frontend/Dockerfile \
              NeuronDesktop/frontend/
          else
            echo "âš  Warning: NeuronDesktop Frontend Dockerfile not found, skipping frontend image build"
          fi
      
      - name: Generate SBOMs
        uses: anchore/sbom-action@v0
        with:
          image: |
            ghcr.io/neurondb/neurondb-postgres:${{ steps.version.outputs.version }}
            ghcr.io/neurondb/neuronagent:${{ steps.version.outputs.version }}
            ghcr.io/neurondb/neuronmcp:${{ steps.version.outputs.version }}
            ghcr.io/neurondb/neurondesktop-api:${{ steps.version.outputs.version }}
            ghcr.io/neurondb/neurondesktop-frontend:${{ steps.version.outputs.version }}
          format: spdx-json
          output-file: sboms.json
      
      - name: Sign images
        uses: sigstore/cosign-installer@v3
      
      - name: Sign with cosign
        env:
          COSIGN_EXPERIMENTAL: 'true'
        run: |
          cosign sign --yes ghcr.io/neurondb/neurondb-postgres:${{ steps.version.outputs.version }}
          cosign sign --yes ghcr.io/neurondb/neuronagent:${{ steps.version.outputs.version }}
          cosign sign --yes ghcr.io/neurondb/neuronmcp:${{ steps.version.outputs.version }}
          cosign sign --yes ghcr.io/neurondb/neurondesktop-api:${{ steps.version.outputs.version }}
          cosign sign --yes ghcr.io/neurondb/neurondesktop-frontend:${{ steps.version.outputs.version }}
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: sboms.json
          generate_release_notes: true
          draft: false
          prerelease: false




