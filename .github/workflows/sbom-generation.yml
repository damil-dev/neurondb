name: SBOM Generation

on:
  workflow_dispatch:

jobs:
  generate-sbom:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Syft
        uses: anchore/sbom-action/download-syft@v0
        with:
          syft-version: 'latest'

      - name: Generate SBOM for images
        env:
          IMAGE_TAG: ${{ github.ref_name == 'refs/heads/main' && 'latest' || (github.ref_name == 'MAIN_WORKFLOWS' && 'latest' || github.ref_name) }}
        run: |
          mkdir -p sbom
          IMAGES=(
            "ghcr.io/neurondb/neurondb-postgres:$IMAGE_TAG"
            "ghcr.io/neurondb/neuronagent:$IMAGE_TAG"
            "ghcr.io/neurondb/neuronmcp:$IMAGE_TAG"
            "ghcr.io/neurondb/neurondesktop-api:$IMAGE_TAG"
            "ghcr.io/neurondb/neurondesktop-frontend:$IMAGE_TAG"
          )
          
          for IMAGE in "${IMAGES[@]}"; do
            IMAGE_NAME=$(echo $IMAGE | cut -d'/' -f3 | cut -d':' -f1)
            echo "Generating SBOM for $IMAGE"
            if syft $IMAGE -o spdx-json > "sbom/${IMAGE_NAME}-${IMAGE_TAG}.spdx.json" 2>&1; then
              syft $IMAGE -o cyclonedx-json > "sbom/${IMAGE_NAME}-${IMAGE_TAG}.cyclonedx.json" 2>&1
              echo "✓ Successfully generated SBOM for $IMAGE"
            else
              echo "⚠ Warning: Could not generate SBOM for $IMAGE (image may not exist, continuing...)"
              continue
            fi
          done

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom/
          retention-days: 90

      - name: Attach SBOM to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: sbom/*.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

