name: NeuronDB - Build and Test

on:
  push:
    branches: [main, develop]
    paths:
      - 'NeuronDB/**'
      - '.github/workflows/neurondb-build-and-test.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'NeuronDB/**'
      - '.github/workflows/neurondb-build-and-test.yml'
  workflow_dispatch:

jobs:
  build-neurondb:
    name: Build NeuronDB (PG ${{ matrix.pg_version }}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # PostgreSQL 16
          - pg_version: "16"
            os: ubuntu-20.04
            compiler: gcc
          - pg_version: "16"
            os: ubuntu-22.04
            compiler: gcc
          - pg_version: "16"
            os: macos-13
            compiler: clang
          
          # PostgreSQL 17
          - pg_version: "17"
            os: ubuntu-22.04
            compiler: gcc
          - pg_version: "17"
            os: ubuntu-22.04
            compiler: clang
          - pg_version: "17"
            os: macos-14
            compiler: clang
          
          # PostgreSQL 18
          - pg_version: "18"
            os: ubuntu-22.04
            compiler: gcc
          - pg_version: "18"
            os: ubuntu-22.04
            compiler: clang
          - pg_version: "18"
            os: macos-13
            compiler: clang
          - pg_version: "18"
            os: macos-14
            compiler: clang
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install PostgreSQL (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-${{ matrix.pg_version }} postgresql-server-dev-${{ matrix.pg_version }}
      
      - name: Install PostgreSQL (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install postgresql@${{ matrix.pg_version }}
          echo "$(brew --prefix postgresql@${{ matrix.pg_version }})/bin" >> $GITHUB_PATH
      
      - name: Install build dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get install -y build-essential make ${{ matrix.compiler }}
      
      - name: Generate neurondb_config.h
        working-directory: NeuronDB
        run: |
          mkdir -p include
          cat > include/neurondb_config.h <<'EOF'
          #ifndef NEURONDB_CONFIG_H
          #define NEURONDB_CONFIG_H
          
          #define NEURONDB_VERSION "1.0"
          #define NEURONDB_BUILD_DATE "$(date +%Y-%m-%d)"
          #define NEURONDB_PG_VERSION ${{ matrix.pg_version }}
          #define NDB_GPU_METAL 1
          #define NEURONDB_CPU_FALLBACK 1
          
          #endif /* NEURONDB_CONFIG_H */
          EOF
      
      - name: Build NeuronDB extension
        working-directory: NeuronDB
        run: |
          if [ "${{ runner.os }}" == "Linux" ]; then
            PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config GPU_BACKENDS=none make clean
            PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config GPU_BACKENDS=none make
          else
            PG_CONFIG=$(brew --prefix postgresql@${{ matrix.pg_version }})/bin/pg_config GPU_BACKENDS=none make clean
            PG_CONFIG=$(brew --prefix postgresql@${{ matrix.pg_version }})/bin/pg_config GPU_BACKENDS=none make
          fi
        env:
          CC: ${{ matrix.compiler }}
      
      - name: Verify build artifacts
        working-directory: NeuronDB
        run: |
          if [ -f neurondb.so ] || [ -f neurondb.dylib ]; then
            echo "✓ Build successful: extension binary found"
            ls -lh neurondb.* || true
          else
            echo "✗ Build failed: extension binary not found"
            exit 1
          fi
      
      - name: Run tests (Linux only)
        if: runner.os == 'Linux'
        working-directory: NeuronDB
        run: |
          sudo PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config make install
          PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg_version }}/bin/pg_config make installcheck || true
        continue-on-error: true
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: neurondb-pg${{ matrix.pg_version }}-${{ matrix.os }}-${{ matrix.compiler }}
          path: |
            NeuronDB/neurondb.so
            NeuronDB/neurondb.dylib
            NeuronDB/neurondb--1.0.sql
          retention-days: 7

  test-summary:
    name: NeuronDB Build Summary
    runs-on: ubuntu-latest
    needs: build-neurondb
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## NeuronDB Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All NeuronDB builds completed for PostgreSQL 16, 17, and 18." >> $GITHUB_STEP_SUMMARY

