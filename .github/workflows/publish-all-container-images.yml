name: Container Images - Publish All Modules

on:
  push:
    tags:
      - 'v*.*.*'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., 1.0.0)'
        required: false
        type: string
      publish_neurondb:
        description: 'Publish NeuronDB images'
        required: false
        type: boolean
        default: true
      publish_neuronagent:
        description: 'Publish NeuronAgent images'
        required: false
        type: boolean
        default: true
      publish_neuronmcp:
        description: 'Publish NeuronMCP images'
        required: false
        type: boolean
        default: true
      publish_neurondesktop:
        description: 'Publish NeuronDesktop images'
        required: false
        type: boolean
        default: true

jobs:
  publish-neurondb-images:
    name: Publish NeuronDB (PG ${{ matrix.pg_version }}, ${{ matrix.platform }})
    if: github.event.inputs.publish_neurondb != 'false'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    strategy:
      fail-fast: false
      matrix:
        pg_version: ["16", "17", "18"]
        platform: ["cpu", "cuda", "rocm"]
        exclude:
          # GPU images only for latest PostgreSQL
          - pg_version: "16"
            platform: "cuda"
          - pg_version: "16"
            platform: "rocm"
          - pg_version: "17"
            platform: "cuda"
          - pg_version: "17"
            platform: "rocm"
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Determine version and tags
        id: meta
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="latest"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"
          
          # Determine Dockerfile
          if [ "${{ matrix.platform }}" = "cpu" ]; then
            echo "dockerfile=dockers/neurondb/Dockerfile" >> $GITHUB_OUTPUT
          else
            echo "dockerfile=dockers/neurondb/Dockerfile.gpu.${{ matrix.platform }}" >> $GITHUB_OUTPUT
          fi
          
          # Set platforms
          if [ "${{ matrix.platform }}" = "cpu" ]; then
            echo "platforms=linux/amd64,linux/arm64" >> $GITHUB_OUTPUT
          else
            echo "platforms=linux/amd64" >> $GITHUB_OUTPUT
          fi
      
      - name: Build and push NeuronDB image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ steps.meta.outputs.dockerfile }}
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/neurondb:${{ steps.meta.outputs.version }}-pg${{ matrix.pg_version }}-${{ matrix.platform }}
            ghcr.io/${{ github.repository_owner }}/neurondb:pg${{ matrix.pg_version }}-${{ matrix.platform }}
          build-args: |
            PG_MAJOR=${{ matrix.pg_version }}
            VERSION=${{ steps.meta.outputs.version }}
            BUILD_DATE=${{ github.event.repository.updated_at }}
            VCS_REF=${{ github.sha }}
          platforms: ${{ steps.meta.outputs.platforms }}
          cache-from: type=gha,scope=neurondb-pg${{ matrix.pg_version }}-${{ matrix.platform }}
          cache-to: type=gha,mode=max,scope=neurondb-pg${{ matrix.pg_version }}-${{ matrix.platform }}
      
      - name: Sign image with Cosign
        if: startsWith(github.ref, 'refs/tags/')
        uses: sigstore/cosign-installer@v3
      
      - name: Sign image
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          cosign sign --yes \
            ghcr.io/${{ github.repository_owner }}/neurondb:${{ steps.meta.outputs.version }}-pg${{ matrix.pg_version }}-${{ matrix.platform }}
        env:
          COSIGN_EXPERIMENTAL: 1

  publish-neuronagent-image:
    name: Publish NeuronAgent
    if: github.event.inputs.publish_neuronagent != 'false'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Determine version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="latest"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"
      
      - name: Build and push NeuronAgent image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: dockers/neuronagent/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/neuronagent:${{ steps.version.outputs.version }}
            ghcr.io/${{ github.repository_owner }}/neuronagent:latest
          build-args: |
            VERSION=${{ steps.version.outputs.version }}
            BUILD_DATE=${{ github.event.repository.updated_at }}
            VCS_REF=${{ github.sha }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha,scope=neuronagent
          cache-to: type=gha,mode=max,scope=neuronagent
      
      - name: Sign image with Cosign
        if: startsWith(github.ref, 'refs/tags/')
        uses: sigstore/cosign-installer@v3
      
      - name: Sign image
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          cosign sign --yes \
            ghcr.io/${{ github.repository_owner }}/neuronagent:${{ steps.version.outputs.version }}
        env:
          COSIGN_EXPERIMENTAL: 1

  publish-neuronmcp-image:
    name: Publish NeuronMCP
    if: github.event.inputs.publish_neuronmcp != 'false'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Determine version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="latest"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"
      
      - name: Build and push NeuronMCP image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: dockers/neuronmcp/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/neuronmcp:${{ steps.version.outputs.version }}
            ghcr.io/${{ github.repository_owner }}/neuronmcp:latest
          build-args: |
            VERSION=${{ steps.version.outputs.version }}
            BUILD_DATE=${{ github.event.repository.updated_at }}
            VCS_REF=${{ github.sha }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha,scope=neuronmcp
          cache-to: type=gha,mode=max,scope=neuronmcp
      
      - name: Sign image with Cosign
        if: startsWith(github.ref, 'refs/tags/')
        uses: sigstore/cosign-installer@v3
      
      - name: Sign image
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          cosign sign --yes \
            ghcr.io/${{ github.repository_owner }}/neuronmcp:${{ steps.version.outputs.version }}
        env:
          COSIGN_EXPERIMENTAL: 1

  publish-neurondesktop-image:
    name: Publish NeuronDesktop
    if: github.event.inputs.publish_neurondesktop != 'false'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Determine version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="latest"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"
      
      - name: Build and push NeuronDesktop image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: dockers/neurondesktop/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/neurondesktop:${{ steps.version.outputs.version }}
            ghcr.io/${{ github.repository_owner }}/neurondesktop:latest
          build-args: |
            VERSION=${{ steps.version.outputs.version }}
            BUILD_DATE=${{ github.event.repository.updated_at }}
            VCS_REF=${{ github.sha }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha,scope=neurondesktop
          cache-to: type=gha,mode=max,scope=neurondesktop
      
      - name: Sign image with Cosign
        if: startsWith(github.ref, 'refs/tags/')
        uses: sigstore/cosign-installer@v3
      
      - name: Sign image
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          cosign sign --yes \
            ghcr.io/${{ github.repository_owner }}/neurondesktop:${{ steps.version.outputs.version }}
        env:
          COSIGN_EXPERIMENTAL: 1

  publish-summary:
    name: Container Publishing Summary
    runs-on: ubuntu-latest
    needs: [publish-neurondb-images, publish-neuronagent-image, publish-neuronmcp-image, publish-neurondesktop-image]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ³ Container Images Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All container images have been published to GitHub Container Registry." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Published Images:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**NeuronDB** (PostgreSQL Extension)" >> $GITHUB_STEP_SUMMARY
          echo "- \`ghcr.io/${{ github.repository_owner }}/neurondb:pg16-cpu\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`ghcr.io/${{ github.repository_owner }}/neurondb:pg17-cpu\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`ghcr.io/${{ github.repository_owner }}/neurondb:pg18-cpu\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`ghcr.io/${{ github.repository_owner }}/neurondb:pg18-cuda\` (GPU)" >> $GITHUB_STEP_SUMMARY
          echo "- \`ghcr.io/${{ github.repository_owner }}/neurondb:pg18-rocm\` (GPU)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**NeuronAgent** (AI Agent Runtime)" >> $GITHUB_STEP_SUMMARY
          echo "- \`ghcr.io/${{ github.repository_owner }}/neuronagent:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**NeuronMCP** (MCP Server)" >> $GITHUB_STEP_SUMMARY
          echo "- \`ghcr.io/${{ github.repository_owner }}/neuronmcp:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**NeuronDesktop** (Web Interface)" >> $GITHUB_STEP_SUMMARY
          echo "- \`ghcr.io/${{ github.repository_owner }}/neurondesktop:latest\`" >> $GITHUB_STEP_SUMMARY

