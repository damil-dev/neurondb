#!/bin/bash
set -e

# Post-installation script for NeuronMCP

# Create neuronmcp user and group if they don't exist
if ! getent group neuronmcp > /dev/null 2>&1; then
    groupadd --system neuronmcp
fi

if ! getent passwd neuronmcp > /dev/null 2>&1; then
    useradd --system --gid neuronmcp --home-dir /var/lib/neuronmcp \
            --shell /usr/sbin/nologin --comment "NeuronMCP service user" neuronmcp
fi

# Create directories
mkdir -p /var/lib/neuronmcp
mkdir -p /var/log/neuronmcp

# Set permissions
chown -R neuronmcp:neuronmcp /var/lib/neuronmcp
chown -R neuronmcp:neuronmcp /var/log/neuronmcp
chmod 755 /etc/neuronmcp
chmod 755 /var/lib/neuronmcp
chmod 755 /var/log/neuronmcp

# If config doesn't exist, copy example
if [ ! -f /etc/neuronmcp/mcp-config.json ]; then
    if [ -f /etc/neuronmcp/mcp-config.json.example ]; then
        cp /etc/neuronmcp/mcp-config.json.example /etc/neuronmcp/mcp-config.json
        chown neuronmcp:neuronmcp /etc/neuronmcp/mcp-config.json
        chmod 640 /etc/neuronmcp/mcp-config.json
        echo "Created /etc/neuronmcp/mcp-config.json from example"
        echo "Please edit /etc/neuronmcp/mcp-config.json to configure your database connection"
    fi
fi

echo "NeuronMCP installed successfully."
echo "Configuration: /etc/neuronmcp/mcp-config.json"
echo "Logs: /var/log/neuronmcp/"

exit 0
