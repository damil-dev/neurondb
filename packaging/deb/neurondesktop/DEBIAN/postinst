#!/bin/bash
set -e

# Post-installation script for NeuronDesktop

# Create neurondesktop user and group if they don't exist
if ! getent group neurondesktop > /dev/null 2>&1; then
    groupadd --system neurondesktop
fi

if ! getent passwd neurondesktop > /dev/null 2>&1; then
    useradd --system --gid neurondesktop --home-dir /var/lib/neurondesktop \
            --shell /usr/sbin/nologin --comment "NeuronDesktop service user" neurondesktop
fi

# Create directories
mkdir -p /etc/neurondesktop
mkdir -p /var/lib/neurondesktop
mkdir -p /var/log/neurondesktop
mkdir -p /var/www/neurondesktop

# Set permissions
chown -R neurondesktop:neurondesktop /var/lib/neurondesktop
chown -R neurondesktop:neurondesktop /var/log/neurondesktop
chown -R neurondesktop:neurondesktop /var/www/neurondesktop
chmod 755 /etc/neurondesktop
chmod 755 /var/lib/neurondesktop
chmod 755 /var/log/neurondesktop
chmod 755 /var/www/neurondesktop

# If config doesn't exist, create example
if [ ! -f /etc/neurondesktop/config.yaml ]; then
    cat > /etc/neurondesktop/config.yaml << 'EOF'
# NeuronDesktop Configuration
server:
  host: "0.0.0.0"
  port: 8081
  frontend_dir: "/var/www/neurondesktop"

database:
  host: "localhost"
  port: 5432
  name: "neurondesk"
  user: "neurondesk"
  password: ""

neuronagent:
  endpoint: "http://localhost:8080"
  api_key: ""

neurondb:
  host: "localhost"
  port: 5432
  database: "neurondb"
  user: "neurondb"
  password: ""
EOF
    chown neurondesktop:neurondesktop /etc/neurondesktop/config.yaml
    chmod 640 /etc/neurondesktop/config.yaml
    echo "Created /etc/neurondesktop/config.yaml"
    echo "Please edit /etc/neurondesktop/config.yaml to configure your connections"
fi

# Reload systemd and enable service (but don't start)
if [ -f /etc/systemd/system/neurondesktop.service ]; then
    systemctl daemon-reload
    systemctl enable neurondesktop.service
    echo "NeuronDesktop service enabled. Start it with: systemctl start neurondesktop"
fi

echo "NeuronDesktop installed successfully."
echo "Configuration: /etc/neurondesktop/config.yaml"
echo "Logs: /var/log/neurondesktop/"
echo "Web interface: http://localhost:8081"

exit 0


