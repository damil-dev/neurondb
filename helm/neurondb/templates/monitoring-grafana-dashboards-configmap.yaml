{{- if and .Values.monitoring.enabled .Values.monitoring.grafana.enabled }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "neurondb.fullname" . }}-grafana-dashboards
  labels:
    {{- include "neurondb.labels" . | nindent 4 }}
    app.kubernetes.io/component: grafana
data:
  neurondb-overview.json: |
    {
      "dashboard": {
        "title": "NeuronDB Overview",
        "tags": ["neurondb", "postgresql", "database"],
        "timezone": "browser",
        "schemaVersion": 38,
        "version": 1,
        "refresh": "30s",
        "panels": [
          {
            "id": 1,
            "title": "Database Connections",
            "type": "stat",
            "gridPos": {"h": 8, "w": 6, "x": 0, "y": 0},
            "targets": [{
              "expr": "pg_stat_database_numbackends{datname=\"neurondb\"}",
              "legendFormat": "Active Connections"
            }],
            "fieldConfig": {
              "defaults": {
                "color": {"mode": "thresholds"},
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"value": null, "color": "green"},
                    {"value": 50, "color": "yellow"},
                    {"value": 100, "color": "red"}
                  ]
                },
                "unit": "short"
              }
            }
          },
          {
            "id": 2,
            "title": "Database Size",
            "type": "stat",
            "gridPos": {"h": 8, "w": 6, "x": 6, "y": 0},
            "targets": [{
              "expr": "pg_database_size_bytes{datname=\"neurondb\"}",
              "legendFormat": "Database Size"
            }],
            "fieldConfig": {
              "defaults": {
                "unit": "bytes",
                "color": {"mode": "palette-classic"}
              }
            }
          },
          {
            "id": 3,
            "title": "Query Rate",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0},
            "targets": [{
              "expr": "rate(pg_stat_database_xact_commit{datname=\"neurondb\"}[5m]) + rate(pg_stat_database_xact_rollback{datname=\"neurondb\"}[5m])",
              "legendFormat": "Queries/sec"
            }],
            "yaxes": [
              {"format": "reqps", "label": "Queries/sec"},
              {"format": "short"}
            ]
          },
          {
            "id": 4,
            "title": "CPU Usage",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8},
            "targets": [{
              "expr": "rate(container_cpu_usage_seconds_total{pod=~\"neurondb-.*\"}[5m]) * 100",
              "legendFormat": "{{`{{pod}}`}}"
            }],
            "yaxes": [
              {"format": "percent", "max": 100, "label": "CPU %"},
              {"format": "short"}
            ]
          },
          {
            "id": 5,
            "title": "Memory Usage",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8},
            "targets": [{
              "expr": "container_memory_working_set_bytes{pod=~\"neurondb-.*\"}",
              "legendFormat": "{{`{{pod}}`}}"
            }],
            "yaxes": [
              {"format": "bytes", "label": "Memory"},
              {"format": "short"}
            ]
          },
          {
            "id": 6,
            "title": "Cache Hit Ratio",
            "type": "stat",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 16},
            "targets": [{
              "expr": "sum(rate(pg_stat_database_blks_hit{datname=\"neurondb\"}[5m])) / (sum(rate(pg_stat_database_blks_hit{datname=\"neurondb\"}[5m])) + sum(rate(pg_stat_database_blks_read{datname=\"neurondb\"}[5m]))) * 100",
              "legendFormat": "Cache Hit Ratio"
            }],
            "fieldConfig": {
              "defaults": {
                "unit": "percent",
                "min": 0,
                "max": 100,
                "color": {"mode": "thresholds"},
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"value": null, "color": "red"},
                    {"value": 80, "color": "yellow"},
                    {"value": 95, "color": "green"}
                  ]
                }
              }
            }
          }
        ]
      }
    }

  neuronagent-overview.json: |
    {
      "dashboard": {
        "title": "NeuronAgent Overview",
        "tags": ["neuronagent", "api", "agent"],
        "timezone": "browser",
        "schemaVersion": 38,
        "version": 1,
        "refresh": "30s",
        "panels": [
          {
            "id": 1,
            "title": "Request Rate",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0},
            "targets": [{
              "expr": "rate(neurondb_agent_http_requests_total[5m])",
              "legendFormat": "{{`{{method}}`}} {{`{{endpoint}}`}} {{`{{status}}`}}"
            }],
            "yaxes": [
              {"format": "reqps", "label": "Requests/sec"},
              {"format": "short"}
            ]
          },
          {
            "id": 2,
            "title": "Request Duration (p95)",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0},
            "targets": [
              {
                "expr": "histogram_quantile(0.95, rate(neurondb_agent_http_request_duration_seconds_bucket[5m]))",
                "legendFormat": "p95"
              },
              {
                "expr": "histogram_quantile(0.99, rate(neurondb_agent_http_request_duration_seconds_bucket[5m]))",
                "legendFormat": "p99"
              }
            ],
            "yaxes": [
              {"format": "s", "label": "Duration"},
              {"format": "short"}
            ]
          },
          {
            "id": 3,
            "title": "Error Rate",
            "type": "stat",
            "gridPos": {"h": 8, "w": 6, "x": 0, "y": 8},
            "targets": [{
              "expr": "rate(neurondb_agent_http_requests_total{status=~\"5..\"}[5m]) / rate(neurondb_agent_http_requests_total[5m]) * 100",
              "legendFormat": "Error Rate %"
            }],
            "fieldConfig": {
              "defaults": {
                "unit": "percent",
                "color": {"mode": "thresholds"},
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"value": null, "color": "green"},
                    {"value": 1, "color": "yellow"},
                    {"value": 5, "color": "red"}
                  ]
                }
              }
            }
          },
          {
            "id": 4,
            "title": "CPU Usage",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 6, "y": 8},
            "targets": [{
              "expr": "rate(container_cpu_usage_seconds_total{pod=~\".*-neuronagent-.*\"}[5m]) * 100",
              "legendFormat": "{{`{{pod}}`}}"
            }],
            "yaxes": [
              {"format": "percent", "max": 100, "label": "CPU %"},
              {"format": "short"}
            ]
          },
          {
            "id": 5,
            "title": "Memory Usage",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 16},
            "targets": [{
              "expr": "container_memory_working_set_bytes{pod=~\".*-neuronagent-.*\"}",
              "legendFormat": "{{`{{pod}}`}}"
            }],
            "yaxes": [
              {"format": "bytes", "label": "Memory"},
              {"format": "short"}
            ]
          },
          {
            "id": 6,
            "title": "Pod Replicas",
            "type": "stat",
            "gridPos": {"h": 8, "w": 6, "x": 12, "y": 16},
            "targets": [{
              "expr": "count(kube_pod_info{pod=~\".*-neuronagent-.*\"})",
              "legendFormat": "Replicas"
            }],
            "fieldConfig": {
              "defaults": {
                "unit": "short",
                "color": {"mode": "palette-classic"}
              }
            }
          }
        ]
      }
    }

  neurondesktop-overview.json: |
    {
      "dashboard": {
        "title": "NeuronDesktop Overview",
        "tags": ["neurondesktop", "ui", "api"],
        "timezone": "browser",
        "schemaVersion": 38,
        "version": 1,
        "refresh": "30s",
        "panels": [
          {
            "id": 1,
            "title": "API Request Rate",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0},
            "targets": [{
              "expr": "rate(neurondesktop_api_http_requests_total[5m])",
              "legendFormat": "{{`{{method}}`}} {{`{{endpoint}}`}} {{`{{status}}`}}"
            }],
            "yaxes": [
              {"format": "reqps", "label": "Requests/sec"},
              {"format": "short"}
            ]
          },
          {
            "id": 2,
            "title": "API Response Time",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0},
            "targets": [
              {
                "expr": "histogram_quantile(0.95, rate(neurondesktop_api_http_request_duration_seconds_bucket[5m]))",
                "legendFormat": "p95"
              },
              {
                "expr": "histogram_quantile(0.99, rate(neurondesktop_api_http_request_duration_seconds_bucket[5m]))",
                "legendFormat": "p99"
              }
            ],
            "yaxes": [
              {"format": "s", "label": "Duration"},
              {"format": "short"}
            ]
          },
          {
            "id": 3,
            "title": "CPU Usage",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8},
            "targets": [{
              "expr": "rate(container_cpu_usage_seconds_total{pod=~\".*-neurondesktop-api-.*\"}[5m]) * 100",
              "legendFormat": "API {{`{{pod}}`}}"
            }],
            "yaxes": [
              {"format": "percent", "max": 100, "label": "CPU %"},
              {"format": "short"}
            ]
          },
          {
            "id": 4,
            "title": "Memory Usage",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8},
            "targets": [{
              "expr": "container_memory_working_set_bytes{pod=~\".*-neurondesktop-api-.*\"}",
              "legendFormat": "{{`{{pod}}`}}"
            }],
            "yaxes": [
              {"format": "bytes", "label": "Memory"},
              {"format": "short"}
            ]
          },
          {
            "id": 5,
            "title": "Error Rate",
            "type": "stat",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 16},
            "targets": [{
              "expr": "rate(neurondesktop_api_http_requests_total{status=~\"5..\"}[5m]) / rate(neurondesktop_api_http_requests_total[5m]) * 100",
              "legendFormat": "Error Rate %"
            }],
            "fieldConfig": {
              "defaults": {
                "unit": "percent",
                "color": {"mode": "thresholds"},
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"value": null, "color": "green"},
                    {"value": 1, "color": "yellow"},
                    {"value": 5, "color": "red"}
                  ]
                }
              }
            }
          }
        ]
      }
    }

  system-overview.json: |
    {
      "dashboard": {
        "title": "NeuronDB System Overview",
        "tags": ["system", "overview", "neurondb"],
        "timezone": "browser",
        "schemaVersion": 38,
        "version": 1,
        "refresh": "30s",
        "panels": [
          {
            "id": 1,
            "title": "Pod Status",
            "type": "table",
            "gridPos": {"h": 8, "w": 24, "x": 0, "y": 0},
            "targets": [{
              "expr": "kube_pod_status_phase",
              "format": "table",
              "instant": true
            }]
          },
          {
            "id": 2,
            "title": "Total CPU Usage",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8},
            "targets": [{
              "expr": "sum(rate(container_cpu_usage_seconds_total[5m])) * 100",
              "legendFormat": "Total CPU %"
            }],
            "yaxes": [
              {"format": "percent", "label": "CPU %"},
              {"format": "short"}
            ]
          },
          {
            "id": 3,
            "title": "Total Memory Usage",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8},
            "targets": [{
              "expr": "sum(container_memory_working_set_bytes)",
              "legendFormat": "Total Memory"
            }],
            "yaxes": [
              {"format": "bytes", "label": "Memory"},
              {"format": "short"}
            ]
          },
          {
            "id": 4,
            "title": "Network I/O",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 16},
            "targets": [
              {
                "expr": "sum(rate(container_network_receive_bytes_total[5m]))",
                "legendFormat": "Receive"
              },
              {
                "expr": "sum(rate(container_network_transmit_bytes_total[5m]))",
                "legendFormat": "Transmit"
              }
            ],
            "yaxes": [
              {"format": "Bps", "label": "Bytes/sec"},
              {"format": "short"}
            ]
          },
          {
            "id": 5,
            "title": "Disk I/O",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 16},
            "targets": [
              {
                "expr": "sum(rate(container_fs_reads_bytes_total[5m]))",
                "legendFormat": "Read"
              },
              {
                "expr": "sum(rate(container_fs_writes_bytes_total[5m]))",
                "legendFormat": "Write"
              }
            ],
            "yaxes": [
              {"format": "Bps", "label": "Bytes/sec"},
              {"format": "short"}
            ]
          }
        ]
      }
    }
{{- end }}

