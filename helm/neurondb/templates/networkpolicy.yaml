{{- if .Values.networkPolicy.enabled }}
{{- /* NeuronDB NetworkPolicy - Default deny, allow ingress from components only */}}
{{- if .Values.neurondb.enabled }}
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "neurondb.fullname" . }}-neurondb
  labels:
    {{- include "neurondb.neurondb.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      {{- include "neurondb.neurondb.selectorLabels" . | nindent 6 }}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  {{- if .Values.neuronagent.enabled }}
  - from:
    - podSelector:
        matchLabels:
          {{- include "neurondb.neuronagent.selectorLabels" . | nindent 10 }}
    ports:
    - protocol: TCP
      port: {{ .Values.neurondb.postgresql.port }}
  {{- end }}
  {{- if .Values.neuronmcp.enabled }}
  - from:
    - podSelector:
        matchLabels:
          {{- include "neurondb.neuronmcp.selectorLabels" . | nindent 10 }}
    ports:
    - protocol: TCP
      port: {{ .Values.neurondb.postgresql.port }}
  {{- end }}
  {{- if .Values.neurondesktop.enabled }}
  - from:
    - podSelector:
        matchLabels:
          {{- include "neurondb.neurondesktop-api.selectorLabels" . | nindent 10 }}
    ports:
    - protocol: TCP
      port: {{ .Values.neurondb.postgresql.port }}
  {{- end }}
  {{- if .Values.networkPolicy.allowMonitoring }}
  - from:
    - namespaceSelector:
        matchLabels:
          {{- with .Values.networkPolicy.monitoringNamespace }}
          name: {{ . }}
          {{- else }}
          name: {{ .Release.Namespace }}
          {{- end }}
      podSelector:
        matchLabels:
          {{- with .Values.networkPolicy.monitoringLabels }}
          {{- toYaml . | nindent 10 }}
          {{- else }}
          app: prometheus
          {{- end }}
    ports:
    - protocol: TCP
      port: {{ .Values.monitoring.prometheus.postgresExporter.port | default 9187 }}
  {{- end }}
  egress:
  # Allow DNS
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: UDP
      port: 53
  # Allow egress to monitoring endpoints if enabled
  {{- if .Values.networkPolicy.allowMonitoring }}
  - to:
    - namespaceSelector:
        matchLabels:
          {{- with .Values.networkPolicy.monitoringNamespace }}
          name: {{ . }}
          {{- else }}
          name: {{ .Release.Namespace }}
          {{- end }}
      podSelector:
        matchLabels:
          {{- with .Values.networkPolicy.monitoringLabels }}
          {{- toYaml . | nindent 10 }}
          {{- else }}
          app: prometheus
          {{- end }}
    ports:
    - protocol: TCP
      port: 9090
  {{- end }}
{{- end }}

{{- /* NeuronAgent NetworkPolicy - Allow ingress from ingress controller, egress to NeuronDB */}}
{{- if .Values.neuronagent.enabled }}
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "neurondb.fullname" . }}-neuronagent
  labels:
    {{- include "neurondb.neuronagent.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      {{- include "neurondb.neuronagent.selectorLabels" . | nindent 6 }}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  {{- if .Values.ingress.enabled }}
  - from:
    - namespaceSelector:
        matchLabels:
          {{- with .Values.networkPolicy.ingressNamespace }}
          name: {{ . }}
          {{- else }}
          name: {{ .Release.Namespace }}
          {{- end }}
      podSelector:
        matchLabels:
          {{- with .Values.networkPolicy.ingressLabels }}
          {{- toYaml . | nindent 10 }}
          {{- else }}
          app.kubernetes.io/name: ingress-nginx
          {{- end }}
    ports:
    - protocol: TCP
      port: {{ .Values.neuronagent.service.port }}
  {{- end }}
  {{- if .Values.networkPolicy.allowMonitoring }}
  - from:
    - namespaceSelector:
        matchLabels:
          {{- with .Values.networkPolicy.monitoringNamespace }}
          name: {{ . }}
          {{- else }}
          name: {{ .Release.Namespace }}
          {{- end }}
      podSelector:
        matchLabels:
          {{- with .Values.networkPolicy.monitoringLabels }}
          {{- toYaml . | nindent 10 }}
          {{- else }}
          app: prometheus
          {{- end }}
    ports:
    - protocol: TCP
      port: {{ .Values.neuronagent.service.port }}
  {{- end }}
  egress:
  # Allow DNS
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: UDP
      port: 53
  # Allow egress to NeuronDB
  {{- if .Values.neurondb.enabled }}
  - to:
    - podSelector:
        matchLabels:
          {{- include "neurondb.neurondb.selectorLabels" . | nindent 10 }}
    ports:
    - protocol: TCP
      port: {{ .Values.neurondb.postgresql.port }}
  {{- end }}
  # Allow egress to monitoring endpoints if enabled
  {{- if .Values.networkPolicy.allowMonitoring }}
  - to:
    - namespaceSelector:
        matchLabels:
          {{- with .Values.networkPolicy.monitoringNamespace }}
          name: {{ . }}
          {{- else }}
          name: {{ .Release.Namespace }}
          {{- end }}
      podSelector:
        matchLabels:
          {{- with .Values.networkPolicy.monitoringLabels }}
          {{- toYaml . | nindent 10 }}
          {{- else }}
          app: prometheus
          {{- end }}
    ports:
    - protocol: TCP
      port: 9090
  {{- end }}
{{- end }}

{{- /* NeuronMCP NetworkPolicy - Allow ingress from allowed namespaces, egress to NeuronDB */}}
{{- if .Values.neuronmcp.enabled }}
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "neurondb.fullname" . }}-neuronmcp
  labels:
    {{- include "neurondb.neuronmcp.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      {{- include "neurondb.neuronmcp.selectorLabels" . | nindent 6 }}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  {{- range .Values.networkPolicy.allowedNamespaces }}
  - from:
    - namespaceSelector:
        matchLabels:
          name: {{ . }}
  {{- end }}
  {{- if .Values.networkPolicy.allowMonitoring }}
  - from:
    - namespaceSelector:
        matchLabels:
          {{- with .Values.networkPolicy.monitoringNamespace }}
          name: {{ . }}
          {{- else }}
          name: {{ .Release.Namespace }}
          {{- end }}
      podSelector:
        matchLabels:
          {{- with .Values.networkPolicy.monitoringLabels }}
          {{- toYaml . | nindent 10 }}
          {{- else }}
          app: prometheus
          {{- end }}
  {{- end }}
  egress:
  # Allow DNS
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: UDP
      port: 53
  # Allow egress to NeuronDB
  {{- if .Values.neurondb.enabled }}
  - to:
    - podSelector:
        matchLabels:
          {{- include "neurondb.neurondb.selectorLabels" . | nindent 10 }}
    ports:
    - protocol: TCP
      port: {{ .Values.neurondb.postgresql.port }}
  {{- end }}
  # Allow egress to monitoring endpoints if enabled
  {{- if .Values.networkPolicy.allowMonitoring }}
  - to:
    - namespaceSelector:
        matchLabels:
          {{- with .Values.networkPolicy.monitoringNamespace }}
          name: {{ . }}
          {{- else }}
          name: {{ .Release.Namespace }}
          {{- end }}
      podSelector:
        matchLabels:
          {{- with .Values.networkPolicy.monitoringLabels }}
          {{- toYaml . | nindent 10 }}
          {{- else }}
          app: prometheus
          {{- end }}
    ports:
    - protocol: TCP
      port: 9090
  {{- end }}
{{- end }}

{{- /* NeuronDesktop API NetworkPolicy - Allow ingress from frontend and ingress controller, egress to NeuronDB */}}
{{- if .Values.neurondesktop.enabled }}
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "neurondb.fullname" . }}-neurondesktop-api
  labels:
    {{- include "neurondb.neurondesktop-api.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      {{- include "neurondb.neurondesktop-api.selectorLabels" . | nindent 6 }}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          {{- include "neurondb.neurondesktop-frontend.selectorLabels" . | nindent 10 }}
    ports:
    - protocol: TCP
      port: {{ .Values.neurondesktop.api.service.port }}
  {{- if .Values.ingress.enabled }}
  - from:
    - namespaceSelector:
        matchLabels:
          {{- with .Values.networkPolicy.ingressNamespace }}
          name: {{ . }}
          {{- else }}
          name: {{ .Release.Namespace }}
          {{- end }}
      podSelector:
        matchLabels:
          {{- with .Values.networkPolicy.ingressLabels }}
          {{- toYaml . | nindent 10 }}
          {{- else }}
          app.kubernetes.io/name: ingress-nginx
          {{- end }}
    ports:
    - protocol: TCP
      port: {{ .Values.neurondesktop.api.service.port }}
  {{- end }}
  {{- if .Values.networkPolicy.allowMonitoring }}
  - from:
    - namespaceSelector:
        matchLabels:
          {{- with .Values.networkPolicy.monitoringNamespace }}
          name: {{ . }}
          {{- else }}
          name: {{ .Release.Namespace }}
          {{- end }}
      podSelector:
        matchLabels:
          {{- with .Values.networkPolicy.monitoringLabels }}
          {{- toYaml . | nindent 10 }}
          {{- else }}
          app: prometheus
          {{- end }}
    ports:
    - protocol: TCP
      port: {{ .Values.neurondesktop.api.service.port }}
  {{- end }}
  egress:
  # Allow DNS
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: UDP
      port: 53
  # Allow egress to NeuronDB
  {{- if .Values.neurondb.enabled }}
  - to:
    - podSelector:
        matchLabels:
          {{- include "neurondb.neurondb.selectorLabels" . | nindent 10 }}
    ports:
    - protocol: TCP
      port: {{ .Values.neurondb.postgresql.port }}
  {{- end }}
  # Allow egress to monitoring endpoints if enabled
  {{- if .Values.networkPolicy.allowMonitoring }}
  - to:
    - namespaceSelector:
        matchLabels:
          {{- with .Values.networkPolicy.monitoringNamespace }}
          name: {{ . }}
          {{- else }}
          name: {{ .Release.Namespace }}
          {{- end }}
      podSelector:
        matchLabels:
          {{- with .Values.networkPolicy.monitoringLabels }}
          {{- toYaml . | nindent 10 }}
          {{- else }}
          app: prometheus
          {{- end }}
    ports:
    - protocol: TCP
      port: 9090
  {{- end }}

{{- /* NeuronDesktop Frontend NetworkPolicy - Allow ingress from ingress controller */}}
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "neurondb.fullname" . }}-neurondesktop-frontend
  labels:
    {{- include "neurondb.neurondesktop-frontend.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      {{- include "neurondb.neurondesktop-frontend.selectorLabels" . | nindent 6 }}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  {{- if .Values.ingress.enabled }}
  - from:
    - namespaceSelector:
        matchLabels:
          {{- with .Values.networkPolicy.ingressNamespace }}
          name: {{ . }}
          {{- else }}
          name: {{ .Release.Namespace }}
          {{- end }}
      podSelector:
        matchLabels:
          {{- with .Values.networkPolicy.ingressLabels }}
          {{- toYaml . | nindent 10 }}
          {{- else }}
          app.kubernetes.io/name: ingress-nginx
          {{- end }}
    ports:
    - protocol: TCP
      port: {{ .Values.neurondesktop.frontend.service.port }}
  {{- end }}
  {{- if .Values.networkPolicy.allowMonitoring }}
  - from:
    - namespaceSelector:
        matchLabels:
          {{- with .Values.networkPolicy.monitoringNamespace }}
          name: {{ . }}
          {{- else }}
          name: {{ .Release.Namespace }}
          {{- end }}
      podSelector:
        matchLabels:
          {{- with .Values.networkPolicy.monitoringLabels }}
          {{- toYaml . | nindent 10 }}
          {{- else }}
          app: prometheus
          {{- end }}
    ports:
    - protocol: TCP
      port: {{ .Values.neurondesktop.frontend.service.port }}
  {{- end }}
  egress:
  # Allow DNS
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: UDP
      port: 53
  # Allow egress to NeuronDesktop API
  - to:
    - podSelector:
        matchLabels:
          {{- include "neurondb.neurondesktop-api.selectorLabels" . | nindent 10 }}
    ports:
    - protocol: TCP
      port: {{ .Values.neurondesktop.api.service.port }}
  # Allow egress to monitoring endpoints if enabled
  {{- if .Values.networkPolicy.allowMonitoring }}
  - to:
    - namespaceSelector:
        matchLabels:
          {{- with .Values.networkPolicy.monitoringNamespace }}
          name: {{ . }}
          {{- else }}
          name: {{ .Release.Namespace }}
          {{- end }}
      podSelector:
        matchLabels:
          {{- with .Values.networkPolicy.monitoringLabels }}
          {{- toYaml . | nindent 10 }}
          {{- else }}
          app: prometheus
          {{- end }}
    ports:
    - protocol: TCP
      port: 9090
  {{- end }}
{{- end }}
{{- end }}
