{{- if .Values.backup.restore.enabled }}
{{- /* Manual restore Job */}}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "neurondb.fullname" . }}-restore-{{ .Values.backup.restore.backupFile | replace "/" "-" | replace "." "-" | trunc 63 }}
  labels:
    {{- include "neurondb.labels" . | nindent 4 }}
    app.kubernetes.io/component: restore
spec:
  backoffLimit: 1
  activeDeadlineSeconds: {{ .Values.backup.restore.activeDeadlineSeconds | default 3600 }}
  template:
    metadata:
      labels:
        {{- include "neurondb.labels" . | nindent 8 }}
        app.kubernetes.io/component: restore
    spec:
      serviceAccountName: {{ include "neurondb.neurondb.serviceAccountName" . }}
      restartPolicy: Never
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
        allowPrivilegeEscalation: false
        capabilities:
          drop:
          - ALL
        seccompProfile:
          type: RuntimeDefault
      initContainers:
      - name: wait-for-db
        image: {{ .Values.backup.waitImage.repository }}:{{ .Values.backup.waitImage.tag }}
        command:
        - sh
        - -c
        - |
          until pg_isready -h {{ include "neurondb.postgresHost" . }} -p {{ include "neurondb.postgresPort" . }} -U {{ include "neurondb.postgresUsername" . }}; do
            echo "Waiting for database to be ready..."
            sleep 2
          done
          echo "Database is ready!"
        env:
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ include "neurondb.postgresPasswordSecret" . }}
              key: {{ include "neurondb.postgresPasswordKey" . }}
      {{- if or .Values.backup.restore.fromS3 .Values.backup.restore.fromGCS .Values.backup.restore.fromAzure }}
      - name: download-backup
        image: {{ .Values.backup.image.repository }}:{{ .Values.backup.image.tag }}
        command:
        - /bin/sh
        - -c
        - |
          set -e
          BACKUP_FILE="{{ .Values.backup.restore.backupFile }}"
          DOWNLOAD_PATH="/restore/$(basename ${BACKUP_FILE})"
          
          echo "Downloading backup: ${BACKUP_FILE}"
          
          {{- if .Values.backup.restore.fromS3 }}
          if ! aws s3 cp "s3://{{ .Values.backup.s3.bucket }}/{{ .Values.backup.s3.prefix | default "backups" }}/${BACKUP_FILE}" \
            "${DOWNLOAD_PATH}" \
            --region {{ .Values.backup.s3.region }}; then
            echo "ERROR: Failed to download backup from S3"
            exit 1
          fi
          {{- end }}
          
          {{- if .Values.backup.restore.fromGCS }}
          if [ ! -f "${GOOGLE_APPLICATION_CREDENTIALS}" ]; then
            echo "ERROR: GCS credentials file not found at ${GOOGLE_APPLICATION_CREDENTIALS}"
            exit 1
          fi
          if ! gsutil cp "gs://{{ .Values.backup.gcs.bucket }}/{{ .Values.backup.gcs.prefix | default "backups" }}/${BACKUP_FILE}" \
            "${DOWNLOAD_PATH}"; then
            echo "ERROR: Failed to download backup from GCS"
            exit 1
          fi
          {{- end }}
          
          {{- if .Values.backup.restore.fromAzure }}
          if [ -n "${AZURE_CLIENT_ID}" ] && [ -n "${AZURE_CLIENT_SECRET}" ] && [ -n "${AZURE_TENANT_ID}" ]; then
            az login --service-principal -u "${AZURE_CLIENT_ID}" -p "${AZURE_CLIENT_SECRET}" --tenant "${AZURE_TENANT_ID}" || true
          fi
          if ! az storage blob download \
            --account-name {{ .Values.backup.azure.accountName }} \
            --container-name {{ .Values.backup.azure.containerName }} \
            --name "{{ .Values.backup.azure.prefix | default "backups" }}/${BACKUP_FILE}" \
            --file "${DOWNLOAD_PATH}" \
            --auth-mode login; then
            echo "ERROR: Failed to download backup from Azure Blob Storage"
            exit 1
          fi
          {{- end }}
          
          echo "Backup downloaded: ${DOWNLOAD_PATH}"
          ls -lh "${DOWNLOAD_PATH}"
        env:
        {{- if .Values.backup.restore.fromS3 }}
        {{- if and .Values.backup.s3.accessKeyId .Values.backup.s3.secretAccessKey }}
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: {{ include "neurondb.fullname" . }}-backup-credentials
              key: aws-access-key-id
              optional: true
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: {{ include "neurondb.fullname" . }}-backup-credentials
              key: aws-secret-access-key
              optional: true
        {{- end }}
        - name: AWS_DEFAULT_REGION
          value: {{ .Values.backup.s3.region | quote }}
        {{- end }}
        {{- if .Values.backup.restore.fromGCS }}
        - name: GOOGLE_APPLICATION_CREDENTIALS
          value: /etc/gcs/credentials.json
        {{- end }}
        {{- if .Values.backup.restore.fromAzure }}
        - name: AZURE_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: {{ include "neurondb.fullname" . }}-backup-credentials
              key: azure-client-id
        - name: AZURE_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: {{ include "neurondb.fullname" . }}-backup-credentials
              key: azure-client-secret
        - name: AZURE_TENANT_ID
          valueFrom:
            secretKeyRef:
              name: {{ include "neurondb.fullname" . }}-backup-credentials
              key: azure-tenant-id
        {{- end }}
        volumeMounts:
        - name: restore-storage
          mountPath: /restore
        {{- if .Values.backup.restore.fromGCS }}
        - name: gcs-credentials
          mountPath: /etc/gcs
          readOnly: true
        {{- end }}
      {{- end }}
      containers:
      - name: restore
        image: {{ .Values.backup.image.repository }}:{{ .Values.backup.image.tag }}
        imagePullPolicy: {{ .Values.backup.image.pullPolicy | default "IfNotPresent" }}
        command:
        - /bin/sh
        - -c
        - |
          set -e
          BACKUP_FILE="{{ .Values.backup.restore.backupFile }}"
          {{- if or .Values.backup.restore.fromS3 .Values.backup.restore.fromGCS .Values.backup.restore.fromAzure }}
          RESTORE_PATH="/restore/$(basename ${BACKUP_FILE})"
          {{- else }}
          RESTORE_PATH="{{ .Values.backup.restore.backupFile }}"
          {{- end }}
          
          echo "Starting restore from: ${RESTORE_PATH}"
          
          # Validate backup file exists
          if [ ! -f "${RESTORE_PATH}" ]; then
            echo "ERROR: Backup file not found: ${RESTORE_PATH}"
            exit 1
          fi
          
          echo "Backup file size: $(ls -lh "${RESTORE_PATH}" | awk '{print $5}')"
          
          # Drop existing connections (optional, may require superuser)
          echo "Terminating existing connections..."
          psql -h {{ include "neurondb.postgresHost" . }} \
            -p {{ include "neurondb.postgresPort" . }} \
            -U {{ include "neurondb.postgresUsername" . }} \
            -d postgres \
            -c "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = '{{ include "neurondb.postgresDatabase" . }}' AND pid <> pg_backend_pid();" || true
          
          # Restore database
          echo "Restoring database..."
          if ! pg_restore -h {{ include "neurondb.postgresHost" . }} \
            -p {{ include "neurondb.postgresPort" . }} \
            -U {{ include "neurondb.postgresUsername" . }} \
            -d {{ include "neurondb.postgresDatabase" . }} \
            -v \
            -c \
            -1 \
            "${RESTORE_PATH}"; then
            echo "ERROR: Database restore failed"
            exit 1
          fi
          
          echo "Restore completed successfully!"
        env:
        - name: PGHOST
          value: {{ include "neurondb.postgresHost" . }}
        - name: PGPORT
          value: {{ include "neurondb.postgresPort" . | quote }}
        - name: PGDATABASE
          value: {{ include "neurondb.postgresDatabase" . }}
        - name: PGUSER
          value: {{ include "neurondb.postgresUsername" . }}
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ include "neurondb.postgresPasswordSecret" . }}
              key: {{ include "neurondb.postgresPasswordKey" . }}
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: false
          runAsNonRoot: true
          runAsUser: 1000
          seccompProfile:
            type: RuntimeDefault
        volumeMounts:
        - name: restore-storage
          mountPath: /restore
        {{- if .Values.backup.restore.fromGCS }}
        - name: gcs-credentials
          mountPath: /etc/gcs
          readOnly: true
        {{- end }}
        resources:
          {{- toYaml (.Values.backup.restore.resources | default (dict "requests" (dict "memory" "1Gi" "cpu" "1") "limits" (dict "memory" "4Gi" "cpu" "4"))) | nindent 14 }}
      volumes:
      - name: restore-storage
        {{- if .Values.backup.restore.persistence.enabled }}
        persistentVolumeClaim:
          claimName: {{ include "neurondb.fullname" . }}-restore
        {{- else }}
        emptyDir: {}
        {{- end }}
      {{- if .Values.backup.restore.fromGCS }}
      - name: gcs-credentials
        secret:
          secretName: {{ include "neurondb.fullname" . }}-backup-credentials
      {{- end }}
{{- end }}

