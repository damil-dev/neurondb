{{- if and .Values.monitoring.enabled .Values.monitoring.prometheus.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "neurondb.fullname" . }}-prometheus-config
  labels:
    {{- include "neurondb.labels" . | nindent 4 }}
    app.kubernetes.io/component: prometheus
data:
  prometheus.yml: |
    global:
      scrape_interval: {{ .Values.monitoring.prometheus.scrapeInterval | default "15s" }}
      evaluation_interval: {{ .Values.monitoring.prometheus.evaluationInterval | default "15s" }}
      external_labels:
        cluster: {{ .Values.monitoring.prometheus.clusterName | default "neurondb" | quote }}
        environment: {{ .Values.monitoring.prometheus.environment | default "production" | quote }}
    
    rule_files:
      - alerts.yml
      - recording_rules.yml
    
    scrape_configs:
      - job_name: 'prometheus'
        static_configs:
          - targets: ['localhost:9090']
      
      - job_name: 'neuronagent'
        kubernetes_sd_configs:
          - role: endpoints
            namespaces:
              names:
                - {{ .Release.Namespace }}
        relabel_configs:
          - source_labels: [__meta_kubernetes_service_name]
            regex: {{ include "neurondb.neuronagent.serviceName" . }}
            action: keep
          - source_labels: [__meta_kubernetes_endpoint_port_name]
            regex: http
            action: keep
        metrics_path: '/metrics'
        scrape_interval: 15s
      
      - job_name: 'neurondesktop-api'
        kubernetes_sd_configs:
          - role: endpoints
            namespaces:
              names:
                - {{ .Release.Namespace }}
        relabel_configs:
          - source_labels: [__meta_kubernetes_service_name]
            regex: {{ include "neurondb.neurondesktop-api.serviceName" . }}
            action: keep
          - source_labels: [__meta_kubernetes_endpoint_port_name]
            regex: http
            action: keep
        metrics_path: '/metrics'
        scrape_interval: 15s
      
      {{- if .Values.monitoring.prometheus.postgresExporter.enabled }}
      - job_name: 'neurondb-postgres'
        kubernetes_sd_configs:
          - role: endpoints
            namespaces:
              names:
                - {{ .Release.Namespace }}
        relabel_configs:
          - source_labels: [__meta_kubernetes_service_name]
            regex: {{ include "neurondb.neurondb.serviceName" . }}
            action: keep
        {{- if .Values.monitoring.prometheus.postgresExporter.port }}
        static_configs:
          - targets: ['{{ include "neurondb.neurondb.serviceName" . }}:{{ .Values.monitoring.prometheus.postgresExporter.port }}']
        {{- end }}
      {{- end }}
    
    alerting:
      alertmanagers:
        {{- if .Values.monitoring.prometheus.alertmanager.enabled }}
        - static_configs:
            - targets:
                - {{ include "neurondb.fullname" . }}-alertmanager:9093
        {{- else }}
        - static_configs:
            - targets: []
        {{- end }}
  
  alerts.yml: |
    groups:
      - name: neurondb_alerts
        interval: 30s
        rules:
          - alert: ServiceDown
            expr: up{job=~"neuronagent|neurondesktop-api"} == 0
            for: 1m
            labels:
              severity: critical
            annotations:
              summary: "Service {{`{{ $labels.job }}`}} is down"
              description: "Service {{`{{ $labels.job }}`}} has been down for more than 1 minute"
          
          - alert: HighErrorRate
            expr: |
              sum(rate(neurondb_agent_http_requests_total{status="5xx"}[5m])) / sum(rate(neurondb_agent_http_requests_total[5m])) > 0.05
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "High error rate in {{`{{ $labels.job }}`}}"
              description: "Error rate is {{`{{ $value | humanizePercentage }}`}} for {{`{{ $labels.job }}`}}"
          
          - alert: HighLatency
            expr: |
              histogram_quantile(0.95, rate(neurondb_agent_http_request_duration_seconds_bucket[5m])) > 1
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High latency in {{`{{ $labels.job }}`}}"
              description: "P95 latency is {{`{{ $value }}`}}s for {{`{{ $labels.job }}`}}"
          
          - alert: DatabaseConnectionFailure
            expr: |
              up{job=~"neurondb.*"} == 0
            for: 2m
            labels:
              severity: critical
            annotations:
              summary: "Database connection failures"
              description: "Cannot connect to NeuronDB database"
          
          - alert: HighMemoryUsage
            expr: |
              (container_memory_working_set_bytes{container="neuronagent"} / container_spec_memory_limit_bytes{container="neuronagent"}) > 0.8
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High memory usage in {{`{{ $labels.job }}`}}"
              description: "Memory usage is {{`{{ $value | humanizePercentage }}`}} for {{`{{ $labels.job }}`}}"
  
  recording_rules.yml: |
    groups:
      # ============================================================================
      # NeuronAgent Recording Rules
      # ============================================================================
      - name: neuronagent_recording
        interval: 30s
        rules:
          # Request rate aggregations
          - record: neuronagent:requests:rate5m
            expr: rate(neurondb_agent_http_requests_total[5m])
          
          - record: neuronagent:requests:rate1m
            expr: rate(neurondb_agent_http_requests_total[1m])
          
          # Error rate calculations (using 5xx status label)
          - record: neuronagent:errors:rate5m
            expr: rate(neurondb_agent_http_requests_total{status="5xx"}[5m])
          
          - record: neuronagent:errors:ratio5m
            expr: |
              rate(neurondb_agent_http_requests_total{status="5xx"}[5m]) / 
              rate(neurondb_agent_http_requests_total[5m])
          
          # Latency percentiles
          - record: neuronagent:request_duration:p50
            expr: histogram_quantile(0.50, rate(neurondb_agent_http_request_duration_seconds_bucket[5m]))
          
          - record: neuronagent:request_duration:p95
            expr: histogram_quantile(0.95, rate(neurondb_agent_http_request_duration_seconds_bucket[5m]))
          
          - record: neuronagent:request_duration:p99
            expr: histogram_quantile(0.99, rate(neurondb_agent_http_request_duration_seconds_bucket[5m]))
      
      # ============================================================================
      # NeuronDesktop Recording Rules
      # ============================================================================
      - name: neurondesktop_recording
        interval: 30s
        rules:
          # Request rate aggregations
          - record: neurondesktop:api:requests:rate5m
            expr: rate(neurondesktop_api_http_requests_total[5m])
          
          - record: neurondesktop:api:requests:rate1m
            expr: rate(neurondesktop_api_http_requests_total[1m])
          
          # Error rate calculations (using 5xx status label)
          - record: neurondesktop:api:errors:rate5m
            expr: rate(neurondesktop_api_http_requests_total{status="5xx"}[5m])
          
          - record: neurondesktop:api:errors:ratio5m
            expr: |
              rate(neurondesktop_api_http_requests_total{status="5xx"}[5m]) / 
              rate(neurondesktop_api_http_requests_total[5m])
          
          # Latency percentiles
          - record: neurondesktop:api:request_duration:p50
            expr: histogram_quantile(0.50, rate(neurondesktop_api_http_request_duration_seconds_bucket[5m]))
          
          - record: neurondesktop:api:request_duration:p95
            expr: histogram_quantile(0.95, rate(neurondesktop_api_http_request_duration_seconds_bucket[5m]))
          
          - record: neurondesktop:api:request_duration:p99
            expr: histogram_quantile(0.99, rate(neurondesktop_api_http_request_duration_seconds_bucket[5m]))
      
      # ============================================================================
      # Infrastructure Recording Rules
      # ============================================================================
      - name: infrastructure_recording
        interval: 30s
        rules:
          # CPU utilization
          - record: infrastructure:cpu:usage:percent
            expr: |
              100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)
          
          # Memory utilization
          - record: infrastructure:memory:usage:percent
            expr: |
              (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100
          
          # Disk utilization
          - record: infrastructure:disk:usage:percent
            expr: |
              (1 - (node_filesystem_avail_bytes{device!~"tmpfs|fuse.lxcfs"} / 
                    node_filesystem_size_bytes{device!~"tmpfs|fuse.lxcfs"})) * 100
{{- end }}

