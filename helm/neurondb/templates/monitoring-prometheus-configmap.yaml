{{- if and .Values.monitoring.enabled .Values.monitoring.prometheus.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "neurondb.fullname" . }}-prometheus-config
  labels:
    {{- include "neurondb.labels" . | nindent 4 }}
    app.kubernetes.io/component: prometheus
data:
  prometheus.yml: |
    global:
      scrape_interval: {{ .Values.monitoring.prometheus.scrapeInterval | default "15s" }}
      evaluation_interval: {{ .Values.monitoring.prometheus.evaluationInterval | default "15s" }}
      external_labels:
        cluster: {{ .Values.monitoring.prometheus.clusterName | default "neurondb" | quote }}
        environment: {{ .Values.monitoring.prometheus.environment | default "production" | quote }}
    
    rule_files:
      - alerts.yml
    
    scrape_configs:
      - job_name: 'prometheus'
        static_configs:
          - targets: ['localhost:9090']
      
      - job_name: 'neuronagent'
        kubernetes_sd_configs:
          - role: endpoints
            namespaces:
              names:
                - {{ .Release.Namespace }}
        relabel_configs:
          - source_labels: [__meta_kubernetes_service_name]
            regex: {{ include "neurondb.neuronagent.serviceName" . }}
            action: keep
          - source_labels: [__meta_kubernetes_endpoint_port_name]
            regex: http
            action: keep
        metrics_path: '/metrics'
        scrape_interval: 15s
      
      - job_name: 'neurondesktop-api'
        kubernetes_sd_configs:
          - role: endpoints
            namespaces:
              names:
                - {{ .Release.Namespace }}
        relabel_configs:
          - source_labels: [__meta_kubernetes_service_name]
            regex: {{ include "neurondb.neurondesktop-api.serviceName" . }}
            action: keep
          - source_labels: [__meta_kubernetes_endpoint_port_name]
            regex: http
            action: keep
        metrics_path: '/metrics'
        scrape_interval: 15s
      
      {{- if .Values.monitoring.prometheus.postgresExporter.enabled }}
      - job_name: 'neurondb-postgres'
        kubernetes_sd_configs:
          - role: endpoints
            namespaces:
              names:
                - {{ .Release.Namespace }}
        relabel_configs:
          - source_labels: [__meta_kubernetes_service_name]
            regex: {{ include "neurondb.neurondb.serviceName" . }}
            action: keep
        {{- if .Values.monitoring.prometheus.postgresExporter.port }}
        static_configs:
          - targets: ['{{ include "neurondb.neurondb.serviceName" . }}:{{ .Values.monitoring.prometheus.postgresExporter.port }}']
        {{- end }}
      {{- end }}
    
    alerting:
      alertmanagers:
        {{- if .Values.monitoring.prometheus.alertmanager.enabled }}
        - static_configs:
            - targets:
                - {{ include "neurondb.fullname" . }}-alertmanager:9093
        {{- else }}
        - static_configs:
            - targets: []
        {{- end }}
  
  alerts.yml: |
    groups:
      - name: neurondb_alerts
        interval: 30s
        rules:
          - alert: ServiceDown
            expr: up{job=~"neuronagent|neurondesktop-api"} == 0
            for: 1m
            labels:
              severity: critical
            annotations:
              summary: "Service {{ $labels.job }} is down"
              description: "Service {{ $labels.job }} has been down for more than 1 minute"
          
          - alert: HighErrorRate
            expr: |
              rate(neurondb_agent_errors_total[5m]) / rate(neurondb_agent_requests_total[5m]) > 0.05
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "High error rate in {{ $labels.job }}"
              description: "Error rate is {{ $value | humanizePercentage }} for {{ $labels.job }}"
          
          - alert: HighLatency
            expr: |
              histogram_quantile(0.95, rate(neurondb_agent_request_duration_seconds_bucket[5m])) > 1
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High latency in {{ $labels.job }}"
              description: "P95 latency is {{ $value }}s for {{ $labels.job }}"
          
          - alert: DatabaseConnectionFailure
            expr: |
              increase(neurondb_database_connection_errors_total[5m]) > 5
            for: 1m
            labels:
              severity: critical
            annotations:
              summary: "Database connection failures"
              description: "{{ $value }} database connection failures in the last 5 minutes"
          
          - alert: HighMemoryUsage
            expr: |
              (process_resident_memory_bytes / process_virtual_memory_bytes) > 0.8
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High memory usage in {{ $labels.job }}"
              description: "Memory usage is {{ $value | humanizePercentage }} for {{ $labels.job }}"
{{- end }}

