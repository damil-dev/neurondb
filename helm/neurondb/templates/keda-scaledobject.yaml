{{- if and .Values.neuronagent.enabled .Values.neuronagent.autoscaling.keda.enabled }}
{{- /* KEDA ScaledObject for advanced autoscaling */}}
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: {{ include "neurondb.fullname" . }}-neuronagent-keda
  labels:
    {{- include "neurondb.neuronagent.labels" . | nindent 4 }}
spec:
  scaleTargetRef:
    name: {{ include "neurondb.fullname" . }}-neuronagent
    apiVersion: apps/v1
    kind: Deployment
  minReplicaCount: {{ .Values.neuronagent.autoscaling.keda.minReplicas | default .Values.neuronagent.autoscaling.minReplicas }}
  maxReplicaCount: {{ .Values.neuronagent.autoscaling.keda.maxReplicas | default .Values.neuronagent.autoscaling.maxReplicas }}
  pollingInterval: {{ .Values.neuronagent.autoscaling.keda.pollingInterval | default 30 }}
  cooldownPeriod: {{ .Values.neuronagent.autoscaling.keda.cooldownPeriod | default 300 }}
  idleReplicaCount: {{ .Values.neuronagent.autoscaling.keda.idleReplicaCount | default 0 }}
  triggers:
  {{- if .Values.neuronagent.autoscaling.keda.triggers.http }}
  - type: prometheus
    metadata:
      serverAddress: {{ .Values.neuronagent.autoscaling.keda.triggers.http.prometheusServer | default "http://prometheus:9090" }}
      metricName: {{ .Values.neuronagent.autoscaling.keda.triggers.http.metricName | default "http_requests_per_second" }}
      threshold: {{ .Values.neuronagent.autoscaling.keda.triggers.http.threshold | default "100" }}
      query: {{ .Values.neuronagent.autoscaling.keda.triggers.http.query | default "sum(rate(http_requests_total[2m]))" }}
  {{- end }}
  {{- if .Values.neuronagent.autoscaling.keda.triggers.queueDepth }}
  - type: postgresql
    metadata:
      connectionStringFromEnv: DATABASE_URL
      query: {{ .Values.neuronagent.autoscaling.keda.triggers.queueDepth.query | default "SELECT COUNT(*) FROM neurondb_agent.job_queue WHERE status = 'pending';" }}
      targetValue: {{ .Values.neuronagent.autoscaling.keda.triggers.queueDepth.targetValue | default "100" }}
  {{- end }}
  {{- if and .Values.neuronagent.autoscaling.keda.triggers.customPrometheus.enabled .Values.neuronagent.autoscaling.keda.triggers.customPrometheus.metricName }}
  - type: prometheus
    metadata:
      serverAddress: {{ .Values.neuronagent.autoscaling.keda.triggers.customPrometheus.prometheusServer | default "http://prometheus:9090" }}
      metricName: {{ .Values.neuronagent.autoscaling.keda.triggers.customPrometheus.metricName }}
      threshold: {{ .Values.neuronagent.autoscaling.keda.triggers.customPrometheus.threshold | default "100" }}
      query: {{ .Values.neuronagent.autoscaling.keda.triggers.customPrometheus.query | default "sum(rate(http_requests_total[2m]))" }}
  {{- end }}
{{- end }}

