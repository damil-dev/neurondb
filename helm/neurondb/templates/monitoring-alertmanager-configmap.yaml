{{- if and .Values.monitoring.enabled .Values.monitoring.prometheus.enabled .Values.monitoring.prometheus.alertmanager.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "neurondb.fullname" . }}-alertmanager-config
  labels:
    {{- include "neurondb.labels" . | nindent 4 }}
    app.kubernetes.io/component: alertmanager
data:
  alertmanager.yml: |
    global:
      resolve_timeout: 5m
      http_config:
        follow_redirects: true

    templates:
      - '/etc/alertmanager/templates/*.tmpl'

    route:
      receiver: 'default'
      group_by: ['alertname', 'cluster', 'service', 'module']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 12h
      routes:
        - match:
            severity: critical
          receiver: 'critical-alerts'
          group_wait: 0s
          group_interval: 5m
          repeat_interval: 4h
          continue: true
        
        - match:
            module: neurondb
          receiver: 'neurondb-alerts'
          group_by: ['alertname', 'instance', 'variant']
          group_wait: 30s
          group_interval: 5m
          repeat_interval: 6h
        
        - match:
            module: neuronagent
          receiver: 'neuronagent-alerts'
          group_by: ['alertname', 'instance', 'variant']
          group_wait: 30s
          group_interval: 5m
          repeat_interval: 6h
        
        - match:
            module: neurondesktop
          receiver: 'neurondesktop-alerts'
          group_by: ['alertname', 'instance']
          group_wait: 30s
          group_interval: 5m
          repeat_interval: 6h
        
        - match:
            module: infrastructure
          receiver: 'infrastructure-alerts'
          group_by: ['alertname', 'instance']
          group_wait: 1m
          group_interval: 10m
          repeat_interval: 12h

    inhibit_rules:
      - source_match:
          severity: 'critical'
        target_match:
          severity: 'warning'
        equal: ['alertname', 'instance', 'module']
      
      - source_match:
          alertname: 'ServiceDown'
        target_match:
          module: 'neurondb'
        equal: ['instance']
      
      - source_match:
          alertname: 'ServiceDown'
        target_match:
          module: 'neuronagent'
        equal: ['instance']
      
      - source_match:
          alertname: 'ServiceDown'
        target_match:
          module: 'neurondesktop'
        equal: ['instance']

    receivers:
      - name: 'default'
        webhook_configs:
          {{- if .Values.monitoring.prometheus.alertmanager.webhook.url }}
          - url: {{ .Values.monitoring.prometheus.alertmanager.webhook.url | quote }}
            send_resolved: true
            http_config:
              follow_redirects: true
          {{- else }}
          - url: 'http://localhost:5001/webhook'
            send_resolved: true
          {{- end }}

      - name: 'critical-alerts'
        webhook_configs:
          {{- if .Values.monitoring.prometheus.alertmanager.webhook.criticalUrl }}
          - url: {{ .Values.monitoring.prometheus.alertmanager.webhook.criticalUrl | quote }}
            send_resolved: true
          {{- else if .Values.monitoring.prometheus.alertmanager.webhook.url }}
          - url: {{ .Values.monitoring.prometheus.alertmanager.webhook.url | quote }}
            send_resolved: true
          {{- else }}
          - url: 'http://localhost:5001/webhook/critical'
            send_resolved: true
          {{- end }}

      - name: 'neurondb-alerts'
        webhook_configs:
          {{- if .Values.monitoring.prometheus.alertmanager.webhook.url }}
          - url: {{ .Values.monitoring.prometheus.alertmanager.webhook.url | quote }}
            send_resolved: true
          {{- else }}
          - url: 'http://localhost:5001/webhook/neurondb'
            send_resolved: true
          {{- end }}

      - name: 'neuronagent-alerts'
        webhook_configs:
          {{- if .Values.monitoring.prometheus.alertmanager.webhook.url }}
          - url: {{ .Values.monitoring.prometheus.alertmanager.webhook.url | quote }}
            send_resolved: true
          {{- else }}
          - url: 'http://localhost:5001/webhook/neuronagent'
            send_resolved: true
          {{- end }}

      - name: 'neurondesktop-alerts'
        webhook_configs:
          {{- if .Values.monitoring.prometheus.alertmanager.webhook.url }}
          - url: {{ .Values.monitoring.prometheus.alertmanager.webhook.url | quote }}
            send_resolved: true
          {{- else }}
          - url: 'http://localhost:5001/webhook/neurondesktop'
            send_resolved: true
          {{- end }}

      - name: 'infrastructure-alerts'
        webhook_configs:
          {{- if .Values.monitoring.prometheus.alertmanager.webhook.url }}
          - url: {{ .Values.monitoring.prometheus.alertmanager.webhook.url | quote }}
            send_resolved: true
          {{- else }}
          - url: 'http://localhost:5001/webhook/infrastructure'
            send_resolved: true
          {{- end }}
{{- end }}



