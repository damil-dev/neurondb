# Unified Docker Compose Configuration for NeuronDB Ecosystem
# Orchestrates NeuronDB, NeuronAgent, and NeuronMCP with automatic networking
#
# Modern Docker Compose (v2) - no version field required
# Usage:
#   CPU (default):  docker compose --profile default up -d
#   CUDA GPU:      docker compose --profile cuda up -d
#   ROCm GPU:       docker compose --profile rocm up -d
#   Metal GPU:      docker compose --profile metal up -d
#
# All services automatically connect via shared 'neurondb-network'
# NeuronAgent and NeuronMCP connect to NeuronDB using container names
#
# Build Methods:
#   - Source build (default): Uses Dockerfile - builds from source in container
#   - Package build: Uses Dockerfile.package - builds DEB packages then installs
#     To use package builds, set: USE_PACKAGE_BUILD=true
#     Package builds are faster and more reproducible
#
# Modern Best Practices Implemented:
#   - Docker Compose v2 (no version field)
#   - init: true for proper signal handling
#   - Labels for service metadata
#   - Health checks for all services
#   - Structured logging with rotation
#   - Resource limits and reservations
#   - Restart policies
#   - Network isolation with IPAM
#   - Profile-based service selection

services:
  neurondb:
    profiles:
    - default
    - cpu
    build:
      context: .
      dockerfile: NeuronDB/docker/Dockerfile.package
      args:
        PG_MAJOR: ${PG_MAJOR:-17}
        PACKAGE_VERSION: ${PACKAGE_VERSION:-1.0.0.beta}
        ONNX_VERSION: ${ONNX_VERSION:-1.17.0}
        VERSION: ${VERSION:-latest}
        BUILD_DATE: ${BUILD_DATE:-}
        VCS_REF: ${VCS_REF:-}
    image: neurondb:cpu-pg17
    container_name: neurondb-cpu
    init: true
    labels:
    - com.neurondb.service=neurondb
    - com.neurondb.variant=cpu
    - com.neurondb.version=${VERSION:-latest}
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-neurondb}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-neurondb}
      POSTGRES_DB: ${POSTGRES_DB:-neurondb}
      POSTGRES_HOST_AUTH_METHOD: ${POSTGRES_HOST_AUTH_METHOD:-md5}
      NEURONDB_GPU_BACKEND_TYPE: ${NEURONDB_GPU_BACKEND_TYPE:-0}
      NEURONDB_COMPUTE_MODE: ${NEURONDB_COMPUTE_MODE:-0}
    ports:
    - ${POSTGRES_PORT:-5433}:5432
    volumes:
    - neurondb-data:/var/lib/postgresql
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U ${POSTGRES_USER:-neurondb} -d ${POSTGRES_DB:-neurondb}
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: '3'
        compress: 'true'
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
    restart: unless-stopped
    networks:
    - neurondb-network
  neurondb-cuda:
    profiles:
    - cuda
    - gpu
    build:
      context: .
      dockerfile: NeuronDB/docker/Dockerfile.package.cuda
      args:
        PG_MAJOR: ${PG_MAJOR:-17}
        CUDA_VERSION: ${CUDA_VERSION:-12.2.0}
        PACKAGE_VERSION: ${PACKAGE_VERSION:-1.0.0.beta}
        ONNX_VERSION: ${ONNX_VERSION:-1.17.0}
        ENABLE_RAPIDS: ${ENABLE_RAPIDS:-0}
        VERSION: ${VERSION:-latest}
        BUILD_DATE: ${BUILD_DATE:-}
        VCS_REF: ${VCS_REF:-}
    image: neurondb:cuda-pg17
    container_name: neurondb-cuda
    init: true
    labels:
    - com.neurondb.service=neurondb
    - com.neurondb.variant=cuda
    - com.neurondb.version=${VERSION:-latest}
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-neurondb}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-neurondb}
      POSTGRES_DB: ${POSTGRES_DB:-neurondb}
      POSTGRES_HOST_AUTH_METHOD: ${POSTGRES_HOST_AUTH_METHOD:-md5}
      NVIDIA_VISIBLE_DEVICES: ${NVIDIA_VISIBLE_DEVICES:-all}
      NVIDIA_DRIVER_CAPABILITIES: ${NVIDIA_DRIVER_CAPABILITIES:-compute,utility}
      NEURONDB_GPU_ENABLED: ${NEURONDB_GPU_ENABLED:-on}
      NEURONDB_GPU_BACKEND_TYPE: ${NEURONDB_GPU_BACKEND_TYPE:-1}
      NEURONDB_COMPUTE_MODE: ${NEURONDB_COMPUTE_MODE:-1}
    ports:
    - ${POSTGRES_CUDA_PORT:-5434}:5432
    volumes:
    - neurondb-cuda-data:/var/lib/postgresql
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U ${POSTGRES_USER:-neurondb} -d ${POSTGRES_DB:-neurondb}
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: '3'
        compress: 'true'
    deploy:
      resources:
        limits:
          cpus: '8'
          memory: 8G
    restart: unless-stopped
    networks:
    - neurondb-network
    # GPU access via runtime (requires nvidia-container-toolkit)
    # Runtime is optional - container will run without GPU if nvidia runtime not available
    # To enable GPU: install nvidia-container-toolkit and uncomment the runtime line below
    # runtime: nvidia
    environment:
      NVIDIA_VISIBLE_DEVICES: ${NVIDIA_VISIBLE_DEVICES:-all}
      NVIDIA_DRIVER_CAPABILITIES: ${NVIDIA_DRIVER_CAPABILITIES:-compute,utility}
  neurondb-rocm:
    profiles:
    - rocm
    - gpu
    build:
      context: ./NeuronDB
      dockerfile: docker/Dockerfile.gpu.rocm
      args:
        PG_MAJOR: ${PG_MAJOR:-17}
        ROCM_VERSION: ${ROCM_VERSION:-5.7}
        ONNX_VERSION: ${ONNX_VERSION:-1.17.0}
        VERSION: ${VERSION:-latest}
        BUILD_DATE: ${BUILD_DATE:-}
        VCS_REF: ${VCS_REF:-}
    image: neurondb:rocm-pg17
    container_name: neurondb-rocm
    init: true
    labels:
    - com.neurondb.service=neurondb
    - com.neurondb.variant=rocm
    - com.neurondb.version=${VERSION:-latest}
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-neurondb}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-neurondb}
      POSTGRES_DB: ${POSTGRES_DB:-neurondb}
      POSTGRES_HOST_AUTH_METHOD: ${POSTGRES_HOST_AUTH_METHOD:-md5}
      NEURONDB_GPU_ENABLED: ${NEURONDB_GPU_ENABLED:-on}
      NEURONDB_GPU_BACKEND_TYPE: ${NEURONDB_GPU_BACKEND_TYPE:-2}
      NEURONDB_COMPUTE_MODE: ${NEURONDB_COMPUTE_MODE:-1}
    ports:
    - ${POSTGRES_ROCM_PORT:-5435}:5432
    volumes:
    - neurondb-rocm-data:/var/lib/postgresql/data
    devices:
    - /dev/kfd:/dev/kfd
    - /dev/dri:/dev/dri
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U ${POSTGRES_USER:-neurondb} -d ${POSTGRES_DB:-neurondb}
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: '3'
        compress: 'true'
    deploy:
      resources:
        limits:
          cpus: '8'
          memory: 8G
    restart: unless-stopped
    networks:
    - neurondb-network
  neurondb-metal:
    profiles:
    - metal
    - gpu
    build:
      context: ./NeuronDB
      dockerfile: docker/Dockerfile.gpu.metal
      args:
        PG_MAJOR: ${PG_MAJOR:-17}
        ONNX_VERSION: ${ONNX_VERSION:-1.17.0}
        VERSION: ${VERSION:-latest}
        BUILD_DATE: ${BUILD_DATE:-}
        VCS_REF: ${VCS_REF:-}
    image: neurondb:metal-pg17
    container_name: neurondb-metal
    init: true
    labels:
    - com.neurondb.service=neurondb
    - com.neurondb.variant=metal
    - com.neurondb.version=${VERSION:-latest}
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-neurondb}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-neurondb}
      POSTGRES_DB: ${POSTGRES_DB:-neurondb}
      POSTGRES_HOST_AUTH_METHOD: ${POSTGRES_HOST_AUTH_METHOD:-md5}
      NEURONDB_GPU_ENABLED: ${NEURONDB_GPU_ENABLED:-on}
      NEURONDB_GPU_BACKEND_TYPE: ${NEURONDB_GPU_BACKEND_TYPE:-3}
      NEURONDB_COMPUTE_MODE: ${NEURONDB_COMPUTE_MODE:-1}
    ports:
    - ${POSTGRES_METAL_PORT:-5436}:5432
    volumes:
    - neurondb-metal-data:/var/lib/postgresql/data
    platform: linux/arm64
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U ${POSTGRES_USER:-neurondb} -d ${POSTGRES_DB:-neurondb}
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: '3'
        compress: 'true'
    deploy:
      resources:
        limits:
          cpus: '8'
          memory: 8G
    restart: unless-stopped
    networks:
    - neurondb-network
  neuronagent:
    profiles:
    - default
    - cpu
    build:
      context: .
      dockerfile: NeuronAgent/docker/Dockerfile.package
      args:
        PACKAGE_VERSION: ${PACKAGE_VERSION:-1.0.0.beta}
        VERSION: ${VERSION:-latest}
        BUILD_DATE: ${BUILD_DATE:-}
        VCS_REF: ${VCS_REF:-}
    image: neuronagent:latest
    container_name: neuronagent
    init: true
    labels:
    - com.neurondb.service=neuronagent
    - com.neurondb.variant=cpu
    - com.neurondb.version=${VERSION:-latest}
    depends_on:
      neurondb:
        condition: service_healthy
    ports:
    - ${SERVER_PORT:-8080}:8080
    environment:
      DB_HOST: ${DB_HOST:-neurondb}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-neurondb}
      DB_USER: ${DB_USER:-neurondb}
      DB_PASSWORD: ${DB_PASSWORD:-neurondb}
      SERVER_HOST: ${SERVER_HOST:-0.0.0.0}
      SERVER_PORT: ${SERVER_PORT:-8080}
      SERVER_READ_TIMEOUT: ${SERVER_READ_TIMEOUT:-30s}
      SERVER_WRITE_TIMEOUT: ${SERVER_WRITE_TIMEOUT:-30s}
      DB_MAX_OPEN_CONNS: ${DB_MAX_OPEN_CONNS:-25}
      DB_MAX_IDLE_CONNS: ${DB_MAX_IDLE_CONNS:-5}
      DB_CONN_MAX_LIFETIME: ${DB_CONN_MAX_LIFETIME:-5m}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOG_FORMAT: ${LOG_FORMAT:-json}
      CONFIG_PATH: ${CONFIG_PATH:-}
    healthcheck:
      test:
      - CMD-SHELL
      - nc -z localhost 8080 || exit 1
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
    restart: unless-stopped
    networks:
    - neurondb-network
  neuronagent-cuda:
    profiles:
    - cuda
    - gpu
    build:
      context: ./NeuronAgent
      dockerfile: docker/Dockerfile
      args:
        VERSION: ${VERSION:-latest}
        BUILD_DATE: ${BUILD_DATE:-}
        VCS_REF: ${VCS_REF:-}
    image: neuronagent:latest
    container_name: neuronagent-cuda
    depends_on:
      neurondb-cuda:
        condition: service_healthy
    ports:
    - ${SERVER_PORT:-8080}:8080
    environment:
      DB_HOST: ${DB_HOST:-neurondb-cuda}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-neurondb}
      DB_USER: ${DB_USER:-neurondb}
      DB_PASSWORD: ${DB_PASSWORD:-neurondb}
      SERVER_HOST: ${SERVER_HOST:-0.0.0.0}
      SERVER_PORT: ${SERVER_PORT:-8080}
      SERVER_READ_TIMEOUT: ${SERVER_READ_TIMEOUT:-30s}
      SERVER_WRITE_TIMEOUT: ${SERVER_WRITE_TIMEOUT:-30s}
      DB_MAX_OPEN_CONNS: ${DB_MAX_OPEN_CONNS:-25}
      DB_MAX_IDLE_CONNS: ${DB_MAX_IDLE_CONNS:-5}
      DB_CONN_MAX_LIFETIME: ${DB_CONN_MAX_LIFETIME:-5m}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOG_FORMAT: ${LOG_FORMAT:-json}
      CONFIG_PATH: ${CONFIG_PATH:-}
    healthcheck:
      test:
      - CMD-SHELL
      - nc -z localhost 8080 || exit 1
      interval: 10s
      timeout: 10s
      start_period: 40s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
    restart: unless-stopped
    networks:
    - neurondb-network
    init: true
    labels:
    - com.neurondb.service=neuronagent
    - com.neurondb.variant=cuda
    - com.neurondb.version=${VERSION:-latest}
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: '3'
        compress: 'true'
  neuronagent-rocm:
    profiles:
    - rocm
    - gpu
    build:
      context: ./NeuronAgent
      dockerfile: docker/Dockerfile
      args:
        VERSION: ${VERSION:-latest}
        BUILD_DATE: ${BUILD_DATE:-}
        VCS_REF: ${VCS_REF:-}
    image: neuronagent:latest
    container_name: neuronagent-rocm
    depends_on:
      neurondb-rocm:
        condition: service_healthy
    ports:
    - ${SERVER_PORT:-8080}:8080
    environment:
      DB_HOST: ${DB_HOST:-neurondb-rocm}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-neurondb}
      DB_USER: ${DB_USER:-neurondb}
      DB_PASSWORD: ${DB_PASSWORD:-neurondb}
      SERVER_HOST: ${SERVER_HOST:-0.0.0.0}
      SERVER_PORT: ${SERVER_PORT:-8080}
      SERVER_READ_TIMEOUT: ${SERVER_READ_TIMEOUT:-30s}
      SERVER_WRITE_TIMEOUT: ${SERVER_WRITE_TIMEOUT:-30s}
      DB_MAX_OPEN_CONNS: ${DB_MAX_OPEN_CONNS:-25}
      DB_MAX_IDLE_CONNS: ${DB_MAX_IDLE_CONNS:-5}
      DB_CONN_MAX_LIFETIME: ${DB_CONN_MAX_LIFETIME:-5m}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOG_FORMAT: ${LOG_FORMAT:-json}
      CONFIG_PATH: ${CONFIG_PATH:-}
    healthcheck:
      test:
      - CMD-SHELL
      - nc -z localhost 8080 || exit 1
      interval: 10s
      timeout: 10s
      start_period: 40s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
    restart: unless-stopped
    networks:
    - neurondb-network
    init: true
    labels:
    - com.neurondb.service=neuronagent
    - com.neurondb.variant=rocm
    - com.neurondb.version=${VERSION:-latest}
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: '3'
        compress: 'true'
  neuronagent-metal:
    profiles:
    - metal
    - gpu
    build:
      context: ./NeuronAgent
      dockerfile: docker/Dockerfile
      args:
        VERSION: ${VERSION:-latest}
        BUILD_DATE: ${BUILD_DATE:-}
        VCS_REF: ${VCS_REF:-}
    image: neuronagent:latest
    container_name: neuronagent-metal
    depends_on:
      neurondb-metal:
        condition: service_healthy
    ports:
    - ${SERVER_PORT:-8080}:8080
    environment:
      DB_HOST: ${DB_HOST:-neurondb-metal}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-neurondb}
      DB_USER: ${DB_USER:-neurondb}
      DB_PASSWORD: ${DB_PASSWORD:-neurondb}
      SERVER_HOST: ${SERVER_HOST:-0.0.0.0}
      SERVER_PORT: ${SERVER_PORT:-8080}
      SERVER_READ_TIMEOUT: ${SERVER_READ_TIMEOUT:-30s}
      SERVER_WRITE_TIMEOUT: ${SERVER_WRITE_TIMEOUT:-30s}
      DB_MAX_OPEN_CONNS: ${DB_MAX_OPEN_CONNS:-25}
      DB_MAX_IDLE_CONNS: ${DB_MAX_IDLE_CONNS:-5}
      DB_CONN_MAX_LIFETIME: ${DB_CONN_MAX_LIFETIME:-5m}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOG_FORMAT: ${LOG_FORMAT:-json}
      CONFIG_PATH: ${CONFIG_PATH:-}
    healthcheck:
      test:
      - CMD-SHELL
      - nc -z localhost 8080 || exit 1
      interval: 10s
      timeout: 10s
      start_period: 40s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
    restart: unless-stopped
    networks:
    - neurondb-network
    init: true
    labels:
    - com.neurondb.service=neuronagent
    - com.neurondb.variant=metal
    - com.neurondb.version=${VERSION:-latest}
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: '3'
        compress: 'true'
  neuronmcp:
    profiles:
    - default
    - cpu
    build:
      context: .
      dockerfile: NeuronMCP/docker/Dockerfile.package
      args:
        PACKAGE_VERSION: ${PACKAGE_VERSION:-1.0.0.beta}
        VERSION: ${VERSION:-latest}
        BUILD_DATE: ${BUILD_DATE:-}
        VCS_REF: ${VCS_REF:-}
    image: neurondb-mcp:latest
    container_name: neurondb-mcp
    init: true
    labels:
    - com.neurondb.service=neuronmcp
    - com.neurondb.variant=cpu
    - com.neurondb.version=${VERSION:-latest}
    depends_on:
      neurondb:
        condition: service_healthy
    environment:
      NEURONDB_HOST: ${NEURONDB_HOST:-neurondb}
      NEURONDB_PORT: ${NEURONDB_PORT:-5432}
      NEURONDB_DATABASE: ${NEURONDB_DATABASE:-neurondb}
      NEURONDB_USER: ${NEURONDB_USER:-neurondb}
      NEURONDB_PASSWORD: ${NEURONDB_PASSWORD:-neurondb}
      NEURONDB_CONNECTION_STRING: ${NEURONDB_CONNECTION_STRING:-}
      NEURONDB_MCP_CONFIG: ${NEURONDB_MCP_CONFIG:-/app/mcp-config.json}
      NEURONDB_LOG_LEVEL: ${NEURONDB_LOG_LEVEL:-info}
      NEURONDB_LOG_FORMAT: ${NEURONDB_LOG_FORMAT:-text}
      NEURONDB_LOG_OUTPUT: ${NEURONDB_LOG_OUTPUT:-stderr}
      NEURONDB_ENABLE_GPU: ${NEURONDB_ENABLE_GPU:-false}
    stdin_open: true
    tty: true
    restart: unless-stopped
    healthcheck:
      test:
      - CMD
      - test
      - -f
      - /app/neurondb-mcp
      - -a
      - -x
      - /app/neurondb-mcp
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 512M
    networks:
    - neurondb-network
  neuronmcp-cuda:
    profiles:
    - cuda
    - gpu
    build:
      context: ./NeuronMCP
      dockerfile: docker/Dockerfile
      args:
        VERSION: ${VERSION:-latest}
        BUILD_DATE: ${BUILD_DATE:-}
        VCS_REF: ${VCS_REF:-}
    image: neurondb-mcp:latest
    container_name: neurondb-mcp-cuda
    depends_on:
      neurondb-cuda:
        condition: service_healthy
    environment:
      NEURONDB_HOST: ${NEURONDB_HOST:-neurondb-cuda}
      NEURONDB_PORT: ${NEURONDB_PORT:-5432}
      NEURONDB_DATABASE: ${NEURONDB_DATABASE:-neurondb}
      NEURONDB_USER: ${NEURONDB_USER:-neurondb}
      NEURONDB_PASSWORD: ${NEURONDB_PASSWORD:-neurondb}
      NEURONDB_CONNECTION_STRING: ${NEURONDB_CONNECTION_STRING:-}
      NEURONDB_MCP_CONFIG: ${NEURONDB_MCP_CONFIG:-/app/mcp-config.json}
      NEURONDB_LOG_LEVEL: ${NEURONDB_LOG_LEVEL:-info}
      NEURONDB_LOG_FORMAT: ${NEURONDB_LOG_FORMAT:-text}
      NEURONDB_LOG_OUTPUT: ${NEURONDB_LOG_OUTPUT:-stderr}
      NEURONDB_ENABLE_GPU: ${NEURONDB_ENABLE_GPU:-true}
    stdin_open: true
    tty: true
    restart: unless-stopped
    healthcheck:
      test:
      - CMD
      - test
      - -f
      - /app/neurondb-mcp
      - -a
      - -x
      - /app/neurondb-mcp
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 512M
    networks:
    - neurondb-network
    init: true
    labels:
    - com.neurondb.service=neuronmcp
    - com.neurondb.variant=cuda
    - com.neurondb.version=${VERSION:-latest}
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: '3'
        compress: 'true'
  neuronmcp-rocm:
    profiles:
    - rocm
    - gpu
    build:
      context: ./NeuronMCP
      dockerfile: docker/Dockerfile
      args:
        VERSION: ${VERSION:-latest}
        BUILD_DATE: ${BUILD_DATE:-}
        VCS_REF: ${VCS_REF:-}
    image: neurondb-mcp:latest
    container_name: neurondb-mcp-rocm
    depends_on:
      neurondb-rocm:
        condition: service_healthy
    environment:
      NEURONDB_HOST: ${NEURONDB_HOST:-neurondb-rocm}
      NEURONDB_PORT: ${NEURONDB_PORT:-5432}
      NEURONDB_DATABASE: ${NEURONDB_DATABASE:-neurondb}
      NEURONDB_USER: ${NEURONDB_USER:-neurondb}
      NEURONDB_PASSWORD: ${NEURONDB_PASSWORD:-neurondb}
      NEURONDB_CONNECTION_STRING: ${NEURONDB_CONNECTION_STRING:-}
      NEURONDB_MCP_CONFIG: ${NEURONDB_MCP_CONFIG:-/app/mcp-config.json}
      NEURONDB_LOG_LEVEL: ${NEURONDB_LOG_LEVEL:-info}
      NEURONDB_LOG_FORMAT: ${NEURONDB_LOG_FORMAT:-text}
      NEURONDB_LOG_OUTPUT: ${NEURONDB_LOG_OUTPUT:-stderr}
      NEURONDB_ENABLE_GPU: ${NEURONDB_ENABLE_GPU:-true}
    stdin_open: true
    tty: true
    restart: unless-stopped
    healthcheck:
      test:
      - CMD
      - test
      - -f
      - /app/neurondb-mcp
      - -a
      - -x
      - /app/neurondb-mcp
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 512M
    networks:
    - neurondb-network
    init: true
    labels:
    - com.neurondb.service=neuronmcp
    - com.neurondb.variant=rocm
    - com.neurondb.version=${VERSION:-latest}
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: '3'
        compress: 'true'
  neuronmcp-metal:
    profiles:
    - metal
    - gpu
    build:
      context: ./NeuronMCP
      dockerfile: docker/Dockerfile
      args:
        VERSION: ${VERSION:-latest}
        BUILD_DATE: ${BUILD_DATE:-}
        VCS_REF: ${VCS_REF:-}
    image: neurondb-mcp:latest
    container_name: neurondb-mcp-metal
    depends_on:
      neurondb-metal:
        condition: service_healthy
    environment:
      NEURONDB_HOST: ${NEURONDB_HOST:-neurondb-metal}
      NEURONDB_PORT: ${NEURONDB_PORT:-5432}
      NEURONDB_DATABASE: ${NEURONDB_DATABASE:-neurondb}
      NEURONDB_USER: ${NEURONDB_USER:-neurondb}
      NEURONDB_PASSWORD: ${NEURONDB_PASSWORD:-neurondb}
      NEURONDB_CONNECTION_STRING: ${NEURONDB_CONNECTION_STRING:-}
      NEURONDB_MCP_CONFIG: ${NEURONDB_MCP_CONFIG:-/app/mcp-config.json}
      NEURONDB_LOG_LEVEL: ${NEURONDB_LOG_LEVEL:-info}
      NEURONDB_LOG_FORMAT: ${NEURONDB_LOG_FORMAT:-text}
      NEURONDB_LOG_OUTPUT: ${NEURONDB_LOG_OUTPUT:-stderr}
      NEURONDB_ENABLE_GPU: ${NEURONDB_ENABLE_GPU:-true}
    stdin_open: true
    tty: true
    restart: unless-stopped
    healthcheck:
      test:
      - CMD
      - test
      - -f
      - /app/neurondb-mcp
      - -a
      - -x
      - /app/neurondb-mcp
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 512M
    networks:
    - neurondb-network
    init: true
    labels:
    - com.neurondb.service=neuronmcp
    - com.neurondb.variant=metal
    - com.neurondb.version=${VERSION:-latest}
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: '3'
        compress: 'true'
  neurondesk-init:
    profiles:
    - default
    - cpu
    image: postgres:16-alpine
    container_name: neurondesk-init
    init: true
    labels:
    - com.neurondb.service=neurondesk-init
    - com.neurondb.variant=cpu
    depends_on:
      neurondb:
        condition: service_healthy
    environment:
      PGHOST: neurondb
      PGPORT: 5432
      PGUSER: ${POSTGRES_USER:-neurondb}
      PGPASSWORD: ${POSTGRES_PASSWORD:-neurondb}
      PGDATABASE: postgres
    command:
      - sh
      - -c
      - |
        set -e
        echo "Waiting for neurondb to be ready..."
        until pg_isready -h neurondb -p 5432 -U $${PGUSER}; do
          sleep 1
        done
        echo "Creating neurondesk database if it doesn't exist..."
        psql -h neurondb -U $${PGUSER} -d postgres -tc "SELECT 1 FROM pg_database WHERE datname = 'neurondesk'" | grep -q 1 || psql -h neurondb -U $${PGUSER} -d postgres -c "CREATE DATABASE neurondesk;"
        echo "Applying NeuronDesktop schema..."
        psql -h neurondb -U $${PGUSER} -d neurondesk -f /schema/neurondesktop.sql || echo "Schema may already be applied (some errors are expected if tables exist)"
        echo "NeuronDesktop database initialization complete!"
    volumes:
      - ./NeuronDesktop/api/neurondesktop.sql:/schema/neurondesktop.sql:ro
    networks:
    - neurondb-network
    restart: "no"
  neurondesk-api:
    profiles:
    - default
    - cpu
    build:
      context: .
      dockerfile: NeuronDesktop/api/Dockerfile
    container_name: neurondesk-api
    init: true
    labels:
    - com.neurondb.service=neurondesk-api
    - com.neurondb.variant=cpu
    - com.neurondb.version=${VERSION:-latest}
    depends_on:
      neurondesk-init:
        condition: service_completed_successfully
      neurondb:
        condition: service_healthy
    environment:
      DB_HOST: neurondb
      DB_PORT: 5432
      DB_USER: ${POSTGRES_USER:-neurondb}
      DB_PASSWORD: ${POSTGRES_PASSWORD:-neurondb}
      DB_NAME: neurondesk
      SERVER_HOST: 0.0.0.0
      SERVER_PORT: 8081
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOG_FORMAT: ${LOG_FORMAT:-json}
      NEURONDB_HOST: ${NEURONDB_HOST:-neurondb}
      NEURONDB_PORT: ${NEURONDB_PORT:-5432}
      NEURONDB_DATABASE: ${NEURONDB_DATABASE:-neurondb}
      NEURONDB_USER: ${NEURONDB_USER:-neurondb}
      NEURONDB_PASSWORD: ${NEURONDB_PASSWORD:-neurondb}
      NEURONAGENT_ENDPOINT: ${NEURONAGENT_ENDPOINT:-http://neuronagent:8080}
      NEURONAGENT_API_KEY: ${NEURONAGENT_API_KEY:-}
    ports:
    - "8081:8081"
    healthcheck:
      test:
      - CMD
      - wget
      - --no-verbose
      - --tries=1
      - --spider
      - http://localhost:8081/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: '3'
        compress: 'true'
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 512M
    restart: unless-stopped
    networks:
    - neurondb-network
  neurondesk-frontend:
    profiles:
    - default
    - cpu
    build:
      context: ./NeuronDesktop/frontend
      dockerfile: Dockerfile
    container_name: neurondesk-frontend
    init: true
    labels:
    - com.neurondb.service=neurondesk-frontend
    - com.neurondb.variant=cpu
    - com.neurondb.version=${VERSION:-latest}
    depends_on:
      neurondesk-api:
        condition: service_healthy
    environment:
      NEXT_PUBLIC_API_URL: http://localhost:8081/api/v1
    ports:
    - "3000:3000"
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: '3'
        compress: 'true'
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
    restart: unless-stopped
    networks:
    - neurondb-network
volumes:
  neurondb-data: null
  neurondb-cuda-data: null
  neurondb-rocm-data: null
  neurondb-metal-data: null
networks:
  neurondb-network:
    name: neurondb-network
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
          gateway: 172.28.0.1
    labels:
      - "com.neurondb.network=main"
