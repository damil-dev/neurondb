# Multi-stage build for NeuronMCP using pre-built DEB package
# This approach is faster and more reproducible than building from source
#
# Build arguments:
#   PACKAGE_VERSION: NeuronMCP package version (default: 1.0.0.beta)
#   VERSION: Application version (used in labels)
#   BUILD_DATE: Build date (ISO 8601 format)
#   VCS_REF: Git commit hash or version control reference
#
# Usage:
#   docker build -f docker/Dockerfile.package \
#     --build-arg PACKAGE_VERSION=1.0.0.beta \
#     -t neuronmcp:package \
#     --build-context packaging=../../packaging \
#     .

ARG PACKAGE_VERSION=1.0.0.beta
ARG VERSION=latest
ARG BUILD_DATE
ARG VCS_REF

FROM debian:bookworm-slim

ARG PACKAGE_VERSION
ARG VERSION
ARG BUILD_DATE
ARG VCS_REF

# Add metadata labels
LABEL org.opencontainers.image.title="NeuronMCP" \
      org.opencontainers.image.description="Model Context Protocol server for NeuronDB PostgreSQL extension" \
      org.opencontainers.image.version="${VERSION}" \
      org.opencontainers.image.created="${BUILD_DATE}" \
      org.opencontainers.image.revision="${VCS_REF}" \
      org.opencontainers.image.vendor="neurondb" \
      org.opencontainers.image.licenses="AGPL-3.0" \
      org.opencontainers.image.source="https://github.com/neurondb/NeurondB" \
      maintainer="neurondb <admin@neurondb.com>" \
      neuronmcp.package.version="${PACKAGE_VERSION}" \
      neuronmcp.build.method="package"

# Install runtime dependencies including Python3 for dataset loading
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        ca-certificates \
        tzdata \
        python3 \
        python3-pip \
        python3-psycopg2 \
        postgresql-client \
        dpkg-dev \
        fakeroot && \
    rm -rf /var/lib/apt/lists/*

# Install Python dependencies for dataset loading
RUN pip3 install --no-cache-dir --break-system-packages \
    datasets \
    psycopg2-binary

# Copy packaging directory from repository root
# Build context should be set to repository root: docker build -f NeuronMCP/docker/Dockerfile.package .
COPY packaging /tmp/packaging

# Build and install the DEB package
RUN set -eux; \
    cd /tmp/packaging/deb/neuronmcp && \
    VERSION="${PACKAGE_VERSION}" ./build.sh && \
    DEB_FILE="neuronmcp_${PACKAGE_VERSION}_amd64.deb" && \
    if [ -f "$DEB_FILE" ]; then \
        dpkg -i "$DEB_FILE" || apt-get install -yf; \
        rm -f "$DEB_FILE"; \
    else \
        echo "Error: DEB package not found after build" >&2; \
        exit 1; \
    fi && \
    rm -rf /tmp/packaging

# Copy optional entrypoint script (can be overridden)
COPY NeuronMCP/docker/docker-entrypoint.sh /usr/local/bin/docker-entrypoint.sh
RUN chmod +x /usr/local/bin/docker-entrypoint.sh && \
    chown root:root /usr/local/bin/docker-entrypoint.sh

# Copy SQL setup scripts
COPY NeuronMCP/sql /usr/share/neuronmcp/sql
RUN chmod -R 644 /usr/share/neuronmcp/sql/*.sql && \
    chown -R neuronmcp:neuronmcp /usr/share/neuronmcp

# The package installs to /usr/bin/neurondb-mcp
# Configuration is in /etc/neuronmcp/mcp-config.json

WORKDIR /var/lib/neuronmcp

# Switch to non-root user (created by package postinst)
USER neuronmcp

# MCP protocol uses stdio, so we don't expose ports
# Keep stdin/stdout/stderr available for MCP communication

# Set entrypoint
ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]
CMD ["/usr/bin/neurondb-mcp"]

