# Multi-stage build for NeuronAgent using pre-built DEB package
# This approach is faster and more reproducible than building from source
#
# Build arguments:
#   PACKAGE_VERSION: NeuronAgent package version (default: 1.0.0.beta)
#   VERSION: Application version (used in labels)
#   BUILD_DATE: Build date (ISO 8601 format)
#   VCS_REF: Git commit hash or version control reference
#
# Usage:
#   docker build -f docker/Dockerfile.package \
#     --build-arg PACKAGE_VERSION=2.0.0.beta \
#     -t neuronagent:package \
#     --build-context packaging=../../packaging \
#     .

ARG PACKAGE_VERSION=3.0.0-devel
ARG VERSION=latest
ARG BUILD_DATE
ARG VCS_REF

FROM debian:bookworm-slim

ARG PACKAGE_VERSION
ARG VERSION
ARG BUILD_DATE
ARG VCS_REF

# Add metadata labels
LABEL org.opencontainers.image.title="NeuronAgent" \
      org.opencontainers.image.description="AI agent runtime system providing REST API and WebSocket endpoints" \
      org.opencontainers.image.version="${VERSION}" \
      org.opencontainers.image.created="${BUILD_DATE}" \
      org.opencontainers.image.revision="${VCS_REF}" \
      org.opencontainers.image.vendor="neurondb" \
      org.opencontainers.image.licenses="Proprietary" \
      org.opencontainers.image.source="https://github.com/neurondb/NeurondB" \
      maintainer="neurondb <admin@neurondb.com>" \
      neuronagent.package.version="${PACKAGE_VERSION}" \
      neuronagent.build.method="package"

# Install runtime dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        ca-certificates \
        tzdata \
        netcat-openbsd \
        postgresql-client \
        dpkg-dev \
        fakeroot && \
    rm -rf /var/lib/apt/lists/*

# Copy packaging directory from repository root
# Build context should be set to repository root: docker build -f NeuronAgent/docker/Dockerfile.package .
COPY packaging /tmp/packaging

# Build and install the DEB package
RUN set -eux; \
    cd /tmp/packaging/deb/neuronagent && \
    VERSION="${PACKAGE_VERSION}" ./build.sh && \
    DEB_FILE="neuronagent_${PACKAGE_VERSION}_amd64.deb" && \
    if [ -f "$DEB_FILE" ]; then \
        dpkg -i "$DEB_FILE" || apt-get install -yf; \
        rm -f "$DEB_FILE"; \
    else \
        echo "Error: DEB package not found after build" >&2; \
        exit 1; \
    fi && \
    rm -rf /tmp/packaging

# Copy optional entrypoint script (can be overridden)
COPY docker/docker-entrypoint.sh /usr/local/bin/docker-entrypoint.sh
RUN chmod +x /usr/local/bin/docker-entrypoint.sh && \
    chown root:root /usr/local/bin/docker-entrypoint.sh

# The package installs to /usr/bin/neuronagent
# Configuration is in /etc/neuronagent/config.yaml
# Migrations are in /usr/share/neuronagent/migrations

WORKDIR /var/lib/neuronagent

# Switch to non-root user (created by package postinst)
USER neuronagent

EXPOSE 8080

# Add health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD nc -z localhost 8080 || exit 1

# Set entrypoint
ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]
CMD ["/usr/bin/neuronagent"]

