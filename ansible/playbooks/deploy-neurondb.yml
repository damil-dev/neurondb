---
# NeuronDB deployment playbook
# Installs PostgreSQL and NeuronDB extension

- name: Deploy NeuronDB
  hosts: all
  become: yes
  gather_facts: yes

  pre_tasks:
    - name: Include existing setup script integration
      include_role:
        name: common
      when: install_neurondb | default(true)

  roles:
    - role: postgresql
      when: install_neurondb | default(true)
    - role: neurondb
      when: install_neurondb | default(true)

  post_tasks:
    - name: Verify NeuronDB installation
      shell: |
        psql -h localhost -U {{ neurondb_database_user | default('neurondb') }} -d {{ neurondb_database_name | default('neurondb') }} -c "SELECT neurondb.version();"
      become_user: "{{ postgresql_user }}"
      register: version_check
      changed_when: false
      failed_when: version_check.rc != 0

    - name: Display NeuronDB version
      debug:
        msg: "{{ version_check.stdout }}"

    - name: Check if health check script exists
      stat:
        path: "{{ ansible_env.HOME }}/neurondb/scripts/neurondb-healthcheck.sh"
      register: healthcheck_script
      delegate_to: localhost
      run_once: true

    - name: Run health check script (if available)
      shell: |
        cd {{ ansible_env.HOME }}/neurondb
        ./scripts/neurondb-healthcheck.sh quick
      when: healthcheck_script.stat.exists | default(false)
      changed_when: false
      failed_when: false
      delegate_to: localhost
      run_once: true

