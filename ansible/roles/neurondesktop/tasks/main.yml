---
# NeuronDesktop installation and configuration

- name: Install Node.js (if not present)
  block:
    - name: Check if Node.js is installed
      command: node --version
      register: node_check
      changed_when: false
      failed_when: false

    - name: Install Node.js via NodeSource (Debian/Ubuntu)
      shell: |
        curl -fsSL https://deb.nodesource.com/setup_{{ nodejs_version }}.x | bash -
        apt-get install -y nodejs
      when: ansible_os_family == "Debian" and node_check.rc != 0
      become: yes

    - name: Install Node.js (RHEL/CentOS/Rocky)
      shell: |
        curl -fsSL https://rpm.nodesource.com/setup_{{ nodejs_version }}.x | bash -
        yum install -y nodejs
      when: ansible_os_family == "RedHat" and node_check.rc != 0
      become: yes

- name: Install Go (if not present)
  block:
    - name: Check if Go is installed
      command: go version
      register: go_check
      changed_when: false
      failed_when: false

    - name: Install Go (Debian/Ubuntu)
      apt:
        name:
          - golang-go
        state: present
      when: ansible_os_family == "Debian" and go_check.rc != 0

    - name: Install Go (RHEL/CentOS/Rocky)
      yum:
        name:
          - golang
        state: present
      when: ansible_os_family == "RedHat" and go_check.rc != 0

- name: Check if NeuronDesktop source exists
  stat:
    path: "{{ neurondesktop_source_dir }}/frontend/package.json"
  register: neurondesktop_source

- name: Clone NeuronDesktop repository
  git:
    repo: "{{ neurondesktop_repo_url | default('https://github.com/neurondb/neurondb.git') }}"
    dest: "{{ neurondesktop_source_dir }}"
    version: "{{ neurondesktop_version | default('main') }}"
    update: no
  when: not neurondesktop_source.stat.exists

- name: Build NeuronDesktop API
  shell: |
    cd {{ neurondesktop_source_dir }}/NeuronDesktop/api
    go mod download
    go build -o {{ neurondesktop_bin_path }}/neurondesk-api ./cmd/server
  args:
    creates: "{{ neurondesktop_bin_path }}/neurondesk-api"
  environment:
    GOPATH: "{{ ansible_env.HOME }}/go"
    GOOS: linux
    GOARCH: amd64
  when: build_from_source | default(false)
  become_user: "{{ neurondb_user }}"

- name: Build NeuronDesktop frontend
  shell: |
    cd {{ neurondesktop_source_dir }}/NeuronDesktop/frontend
    npm install
    npm run build
  args:
    creates: "{{ neurondesktop_frontend_path }}/.next"
  when: build_from_source | default(false)
  become_user: "{{ neurondb_user }}"

- name: Create NeuronDesktop directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ neurondb_user }}"
    group: "{{ neurondb_group }}"
    mode: '0755'
  loop:
    - "{{ neurondesktop_bin_path }}"
    - "{{ neurondesktop_config_dir }}"
    - "{{ neurondesktop_log_dir }}"
    - "{{ neurondesktop_frontend_path }}"

- name: Copy NeuronDesktop binaries (if pre-built)
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: '0755'
    owner: "{{ neurondb_user }}"
    group: "{{ neurondb_group }}"
  loop:
    - { src: "{{ neurondesktop_api_binary_source }}", dest: "{{ neurondesktop_bin_path }}/neurondesk-api" }
    - { src: "{{ neurondesktop_frontend_source }}", dest: "{{ neurondesktop_frontend_path }}" }
  when: not build_from_source | default(true) and neurondesktop_api_binary_source is defined

- name: Copy systemd service files
  template:
    src: "{{ item }}.j2"
    dest: "/etc/systemd/system/{{ item }}"
    mode: '0644'
  loop:
    - neurondesk-api.service
    - neurondesk-frontend.service
  notify:
    - reload systemd
    - restart neurondesktop

- name: Ensure NeuronDesktop services are enabled and started
  systemd:
    name: "{{ item }}"
    enabled: yes
    state: started
    daemon_reload: yes
  loop:
    - neurondesk-api
    - neurondesk-frontend

- name: Wait for NeuronDesktop API to be ready
  uri:
    url: "http://localhost:{{ neurondesktop_api_port }}/health"
    method: GET
    status_code: 200
  register: health_check
  until: health_check.status == 200
  retries: 10
  delay: 3
  ignore_errors: yes

